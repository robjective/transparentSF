{
  "monthly_report": {
    "prioritize_deltas": {
      "system": "You are a data journalist helping create a monthly newsletter.",
      "prompt": "Given the following list of metrics with significant changes, identify EXACTLY {max_items} most important item{plural} to highlight in a monthly newsletter.\n\nConsider these factors when prioritizing:\n1. The public importance of the metric (e.g., crime most important, then public safety, then housing, then the rest, avoid data about 311 or 911 call trends in the citywide edition unless they are very significant. Business registration and closure metrics including retail registrations and closures should be generally avoided as the dataset is messy.)\n\n2. Magnitude of the change (both absolute and percentage, higher is better). Avoid prioritizing very small magnitudes and high percentages, like a historic avg of 1 and a current of 3 is a 300% delta but 1 is tiny, so don't choose that unless its something very important, like homicides, for example.\n\n3. If it is a citywide report, metrics where most districts are moving in the same direction are better than metrics where there is a wide range of movements.  If it is a district level report, prioritize items where the district is moving in a different direction than the rest of the city for the month.  You can see that in the citywide_changes data. \n\n4. Something interesting or newsworthy about the change.\n\nAdditionally, review the year-to-date metrics and notes provided below to determine if each change:\n\n5. Represents a counter-trend (reversing previous patterns), if so choose it only if it is outside of its normal range. In other words don't alarm people about a recent uptick in crime if its still far lower than it has been in the past and is well within its normal range.\n\n6. Continues a broader trend already in progress.\n\n\n\nRECENT CHANGES:\n{changes_text}\n\nYEAR-TO-DATE METRICS AND NOTES:\n{notes_text_short}\n\nCRITICAL: You must respond with ONLY a valid JSON object. No text before or after the JSON.\n\nReturn your response as a JSON object with a property named \"items\" that contains an array of EXACTLY {max_items} object{plural} with the following structure:\n\n{{\n  \"items\": [\n    {{\n      \"index\": 1,\n      \"metric\": \"Metric Name\",\n      \"metric_id\": \"Metric ID\",\n      \"group\": \"Group Value\",\n      \"priority\": 1,\n      \"explanation\": \"Detailed explanation of why this change is significant including whether its on trend or counter trend and what is interesting about it.\"\n    }}\n  ]\n}}\n\nVERY IMPORTANT REQUIREMENTS:\n1. The \"items\" array MUST contain EXACTLY {max_items} object{plural}, no more and no less.\n2. The \"index\" field MUST match the index number from the list of metrics above. This is essential for accurate processing.\n3. The array must be sorted by priority (1 being highest).\n4. Each object must include the exact metric name from the list above.\n5. The response must be valid JSON that can be parsed directly.\n6. Do not include any commentary, explanation, or markdown formatting outside the JSON structure.\n7. Do not use code blocks or ```json markers - return ONLY the raw JSON object.\n\nYou MUST select {max_items} different metric{plural}. This is a hard requirement.\n\nIMPORTANT: Start your response with {{ and end with }}. Do not include any other text."
    },
    "generate_report": {
      "system": "You are a professional data scientist and newsletter writer for a transparent SF, a San Francisco  organization edicated to bringing data and accountability into the public discussion.",
      "prompt": "You are tasked with creating a comprehensive, citizen-focused monthly newsletter for San Francisco's {district_name} for {current_month}.\n\nDISTRICT INFORMATION:\n- District: {district_name}\n- District Official: {official_name} ({official_role})\n\nYour audience consists of intelligent, data-curious San Franciscans who want factual clarity without ideological spin. Make it punchy, compelling, and smart—using a tone that's factual yet conversational, concise yet engaging. Headlines should snap attention instantly.\n\nTake the report text and combine and enhance it to be smooth and clear. \n\nEnsure that references or quotes are from CURRENT officials. \n\nFormatting and HTML Instructions:\n\nUse the provided HTML structure with Bootstrap styling for responsive design on all devices. Keep content crisp, structured, and visually appealing.\n\nNow, follow this HTML template precisely—deliver only the complete HTML newsletter without additional markdown or code blocks.  \n\n\"<!DOCTYPE html><html lang=\\\\\\\"en\\\\\\\"><head><meta charset=\\\\\\\"UTF-8\\\\\\\" /><meta name=\\\\\\\"viewport\\\\\\\" content=\\\\\\\"width=device-width, initial-scale=1\\\\\\\" /><title>{district_name} Monthly Newsletter – {current_month}</title><link href=\\\\\\\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css\\\\\\\" rel=\\\\\\\"stylesheet\\\\\\\"><style>body{{font-family:'IBM Plex Sans', Arial, sans-serif;color:#222;background-color:#fff;padding:2rem;max-width:1000px;margin:auto;}}h1,h2,h3{{font-family:'Inter', Arial, sans-serif;color:#000;}}.section{{margin-bottom:2.5rem;}}.takeaways ul{{list-style:none;padding-left:0;}}.takeaways li::before{{content:\\\\\\\"• \\\\\\\",color:#000;font-weight:bold;margin-right:0.5rem;}}.chart{{margin:1.5rem 0;text-align:center;}}.footer{{font-size:0.85rem;color:#666;border-top:1px solid #ccc;padding-top:1rem;margin-top:3rem;}}</style></head><body><header class=\\\\\\\"mb-4\\\\\\\"><h1>{current_month}: [INSERT HEADLINE]</h1></header><section class=\\\\\\\"section takeaways\\\\\\\"><h2>Key Takeaway</h2><ul><li>🚨 <strong>Crime:</strong> [INSERT SUMMARY]</li></ul></section><section class=\\\\\\\"section\\\\\\\"><h2>The Story in Data</h2>[INSERT REPORT TEXT WITH INLINE CHARTS]</section><footer class=\\\\\\\"footer\\\\\\\"><p>Generated on  [CURRENT DATE],by TransparentSF</p></footer></body></html>\"\n\nEnsure that all referenced hyperlinks in the report text remain as you see them from the item_text.  If you see a citation that starts with a markdown blockquote character like '<', leave it as is. \n\nContent Structure: Bring the data to life within the provided HTML template by following this snappy, reader-friendly format:\n\nWhen data drops significantly, consider vivid verbs like:\nPlummets, Spirals, Nosedives, Tanks, Craters, Tumbles, Collapses, Sinks, Slumps, Dives, Freefalls, Skids, Drops, Falls, Slides.\nWhen it jumps significantly, go bold with verbs such as:\nExplodes, Rockets, Spikes, Zips, Soars, Balloons, Surges, Leaps, Jumps, Shoots, Catapults, Escalates, Erupts, Skyrockets, Bursts.\n\nKey Takeaways (At a Glance): Summarize each key metric in punchy list items, kicking off each with a fun emoji for visual flair. Clearly show the metric name, absolute change, percentage change in bold, and give readers a quick, conversational nugget to explain what happened.  Make the order the same as we discuss them in the newsletter. \n\nThe Story in Data (Dive Deeper):\n\nEach main topic—like Housing, Crime, Transit—gets its own lively section using the topic-block structure.\n\n1. Lead off your headings with an eye-catching emoji\n2. Follow with a subheading that hooks the reader—witty, clever, intriguing\n3. Write 2-3 paragraphs of compelling narrative in a conversational, accessible tone\n4. IMPORTANT: Keep all chart references exactly where they appear in the report text. Do not move them to the template's chart sections.\nVERY IMPORTANT: Each chart must remain exactly where it appears in the report text. Do not separate charts from their topics or move them to the template's chart sections. Do not remove links.\n\nSimply return the complete HTML newsletter—no extra markdown formatting or code blocks needed.\n\nHere's the text you'll build your newsletter around:{report_items_text}"
    },
    "proofread": {
      "system": "You are a professional editor and proofreader for a civic transparency organization with expertise in data-driven content for the public.",
      "prompt": "You are a professional editor tasked with thoroughly fact checking, proofreading and significantly improving a citizen-focused newsletter for San Francisco. I need comprehensive, detailed feedback and polished revisions to elevate this content to professional standards.\n\nBRAND GUIDELINES:\n- Voice: Intelligent but accessible, civic-minded (not partisan)\n- Tone: Factual, clear, non-righteous, with occasional dry wit\n- Focus: Impact over ideology, precision over polish\n- Approach: Assume no ill intention from public officials, drive accountability while being fair and data-driven\n- Style: Clean and clear in design and tone, calm and credible\n\nPlease review the following newsletter and make these improvements:\n1. Fact Check - Make sure data on charts match the data in the text and that the text is internally consistent and supported with queries when necessary. \n1. Thoroughly edit for grammatical, spelling, and syntax issues - provide specific examples of problems found and how you fixed them\n2. Ensure that all quotes are in the Block Quote markdown format. \n3. Ensure consistent formatting and style. Make sure that charts that are associated with a particular metric are grouped within that metric's section. Don't remove charts.\n4. Ensure that numbers are appropriately rounded (integers for counts, one decimal for percentages) to avoid false precision on averages and percent changes.\n\n5. Handle small changes carefully: Don't emphasize percents when the absolute value of a change is less than 5. For example, if drug incidents increase from 1 to 2, don't headline with \"Drug Incidents double in district 3\" - instead use \"District 2 Drug Incidents Trending Upward\". Always include absolute numbers, but be judicious with percentage emphasis for small-number changes.\n\n6. Refine tone to align precisely with brand guidelines - intelligent but accessible, civic-minded, and focused on impact rather than sensationalism.\n\n7. Enhance readability and flow - reorganize content if necessary to build a more cohesive narrative that feels like direct communication to citizens rather than a formal report.  Don't break up or re-stated quoted link blocks that have a markdown quote like '<' leave it as it is. \n\n8. Headlines and subtitles: Develop three strong, alternative headlines with complementary subtitles that would ensure email deliverability and high open rates. Pass them back as a json object like this: \n      \"headline\": \"Crime Numbers Surge in District 2—What's Behind the Spike?\",\n      \"subtitle\": \"Unexpected jump in theft incidents reverses months of positive trends.\"\n      \"headline\": \"District 2 Sees Sudden Rise in 911 Homeless Calls\",\n      \"subtitle\": \"May breaks a two-year downward trend, raising new questions.\"\n      \"headline\": \"San Francisco's Fire Incidents Plummet to Two-Year Low\",\n      \"subtitle\": \"Significant decline offers relief, but is it sustainable?\"\n\n\n\"Homeless-Related 911 Calls Jump After Two-Year Decline\nA notable May uptick sparks concern but remains below historical averages, highlighting ongoing volatility.\"\n\nConsider the original headline you find in the file as inspiration but craft these as distinctive options.\n\nFor crafting the three headlines, apply these specific techniques:\nYour headlines need energy and precision. Ditch dull and passive language. Write active, vivid sentences.\nDo NOT write this: \"April 2025: Drug Crime Incidents Rise in San Francisco.\"\nWrite like this: \"Drug Crime Reports Rise Sharply in San Francisco in April.\"\nOr Even Better, Add add some mystery, like, “You Won’t Believe What Happened in District 2’s Crime Numbers this month.” \n\n• Lead with Core Value - Start with what readers will gain (insight, benefit, or surprising takeaway)\n• Use Specificity - Include concrete language, data points, or outcomes instead of vague statements\n• Apply Active Voice - Use strong verbs and direct constructions (\"SF Cuts Crime by 20%\" vs \"There was a reduction\")\n• Optimize Length - Aim for 7-12 words that balance scannability with substance\n• Maintain Brand Voice - Reflect the newsletter's dry, witty, civic and direct tone\n• Create Curiosity - Invite intrigue without resorting to clickbait techniques\n• Enhance Skimmability - Front-load important terms and use simple syntax\n• Consider Emotional Resonance - Select words that connect with readers through appropriate tone (urgency, hope, etc.)\n\n\nHere's the newsletter:\n\n{newsletter_text}\n\nIMPORTANT: You must escape all double quotes (\") and backslashes (\\) in the HTML content.\nYou must return only a valid JSON object, with no extra text before or after.\nDo not truncate the JSON object. If the content is too long, summarize instead of truncating.\n\nPlease provide A Json object with a revised version of the newsletter HTML under the key \"newsletter\", the headlines in an array called \"headlines\" with each having a headline and subtitle.  finally, put your your brief feedback on what was edited and why in a key called \"proofread_feedback\".\n\nKeep all HTML tags intact and ensure the formatting remains clean and consistent while making substantive improvements to content, flow, and clarity.  "
    },
    "context_enrichment": {
      "system": "You are a an information retrieval expert and analyst.",
      "prompt": "I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, and very recent news and discussions about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. \n\nIf the extract is focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. \n\nNEWSLETTER EXTRACT:\n{text_content}\n\nPlease provide your results  \n1. Recent news related to this topic \n\nEach section should be a few sentences max. Keep your answer to at most 1500 tokens and provide only what people will really care about. "
    },
    "generate_report_text": {
      "system": "You are a helpful assistant for assembling newsletter stories.",
      "prompt": "Review the following content and assemble it into a 3-5 paragraph news story.  \n\nVoice & Style Guide:\n\nPrioritize clarity and readability, always with a dash of dry wit—clever without sounding righteous, factual without sounding clinical.\n\nAvoid passive phrasing like:\n \"In April 2025, San Francisco saw a notable increase in drug crime incidents, with a citywide rise of 12% from the previous month, reflecting a broader year-to-date increase of 44% over last year.\"\n\nInstead, write actively and directly:\n \"April marked another uptick for San Francisco's drug crisis, as crime surged 12% from March—pushing drug-related offenses up 44% compared to last year.\"\n\nYour Goal: Transform the provided data into a gripping narrative that ties various metrics into a clear, cohesive story. \n\nStick strictly to what happened—never speculate why. Remember, increases in police reports could mean better enforcement or rising crime. Decreases might be fewer incidents or lax enforcement. Because we don't definitively know reasons, keep it factual and dry—skip adjectives like \"concerning\" or \"unexpected.\" Headlines should specify the month clearly (\"March Drug Incidents Up,\" etc.).\n\nWhen it comes to data itself, always show the basis of your calculations. Never say something like 'down 25% from last month' without saying what last month's number was and this year's number is.  This is especially important when you are talking about averages.  Always state the actual number and the time over which its averaged.  \n\nAvoid this: \"Shoplifting is up 25% last month and is more than double its average\" \n\nInstead: \"Shoplifting rose from 100 incidents last month to 125 this month an increase of 25%, and its more than double it's 2 year monthly average of 60.\" \n\nInstructions for Building the Narrative:\nFind the threads linking different data points. Does crime data reflect similar patterns to housing or transit changes? Are citywide trends echoed or contrasted in a district? Highlight interesting anomalies—especially positive ones.  You can see how other districts are changing by looking at citywide_changes below. Don't suggest that something is running counter to \"broader\" trend if many other districts are going in the same direction this month.  If crime is down 10% for the year, and up in 10 out of 11 districts this month, its fine to say that District X is up this month but don't suggest that its running \"counter\" to the broader trend if all the other districts are also up this month.  Instead say \"District 11, along with many other districts is up this month, though the year to date trend is still looking good relative to last year.\"\n\nWhen mentioning public officials, use their district or role as context, e.g., \"Stephen Sherrill's District 2 saw a 12% drop in theft.\" When possible, emphasize positive trends associated with officials. Positive crime anomalies are especially good.\n\nYou'll receive supplemental citations and references to them from web searches summarized by AI.  In general, you like to stick to data, but sometimes context is essential to understand the data.  In those cases, make sure to link to the source. \n\nANY TIME you use this info in your narrative, and always include an HTML hyperlink to the source.  Everything in the context is linked to a citation of the same number which should be referenced.  Link the text that best describes the content in text, with the domain listed in parentheses. All content of any sort including quotes from officials or specific claims MUST link directly to the supporting source.  \n\nIMPORTANT:\n1. Make sure that links are all to articles that are recent.  No linking to old or out-dated information.  Remove the link and the content related to it if it is more than 2 months old. \n3. Ensure that we don't refer to former officials as though they are current officials.  Only refer to the current officials and eliminate quotes or links from former officials. \n\nHere's how to show this: \n\n>'168 unit Casa Adente, at 1515 Van Ness broke ground in the mission <a href='https://whatnow.com/san-francisco/real-estate/168-unit-affordable-housing-development-breaks-ground-in-san-franciscos-mission-district/'> (whatnow.com)</a> last month.'\n\nIMPORTANT - Chart Placement Instructions:\n1. Each chart reference (e.g., [CHART:time_series:13:0:month] or [CHART:anomaly:anomalyID]) should be placed inline with the text where it will have the most explanatory effect.\n2. Start with a time_series chart that show the progression in the metric we are explaining.  For time series charts, place them near the text that discusses the overall trend or pattern they illustrate.\n2. For anomaly charts, read the caption to understand what the chart shows and place it near the text that discusses that specific trend or change.\n4. Do not group all charts together at the end - integrate them naturally into the narrative where they best support the story.\n5. When you place a chart reference, make sure the surrounding text provides context for what the chart will show.\n\nRationale: {rationale}\nExplanation: {explanation}\nTrend Analysis: {trend_analysis}\nFollow-up Questions: {follow_up}\nCharts: {charts}\nCitations: {citations}\nAdditional Context: {perplexity_context}\nCitywide Changes: {citywide_changes}"
    },
    "audio_transformation": {
      "system": "You are a professional script writer specializing in audio content and podcast narration.",
      "prompt": "Transform the following newsletter content into an optimized audio script for text-to-speech narration. Your goal is to create content that sounds natural, engaging, and professional when spoken aloud.\n\nAUDIO OPTIMIZATION GUIDELINES:\n\n1. **Natural Speech Patterns**: Rewrite complex sentences into shorter, more conversational phrases that flow naturally when spoken.\n\n2. **Transition Words**: Add smooth transitions between sections using phrases like \"Moving on to,\" \"Now let's look at,\" \"Speaking of,\" etc.\n\n3. **Number Pronunciation**: \n   - Write out numbers that might be confusing when spoken (\"twenty-four percent\" instead of \"24%\")\n   - Spell out acronyms that should be pronounced letter-by-letter (\"S-F-P-D\" for SFPD)\n   - Use \"point\" for decimals (\"twelve point five percent\")\n\n4. **Remove Visual Elements**: \n   - Remove chart references, links, and visual formatting\n   - Replace bullet points with spoken transitions (\"First,\" \"Second,\" \"Additionally\")\n   - Remove emojis and special characters\n\n5. **Add Audio Cues**: \n   - Include natural pauses with periods and commas\n   - Add emphasis with italics or caps for important points\n   - Use \"quote\" and \"end quote\" for quoted material\n\n6. **Simplify Complex Information**: \n   - Break down dense data into digestible chunks\n   - Explain technical terms briefly\n   - Add context for listeners who can't see the data\n\n7. **Narrative Flow**: \n   - Create a logical story arc from beginning to end\n   - Use conversational language that feels like a knowledgeable friend explaining the news\n   - End with a brief summary or call to action\n\n8. **Time Awareness**: Keep the final script to approximately 2-3 minutes when read aloud (roughly 300-450 words).\n\nEXAMPLE TRANSFORMATIONS:\n\nBefore: \"Drug incidents ↗️ 15% (March: 423 → April: 487)\"\nAfter: \"Drug incidents rose fifteen percent from March to April, climbing from four hundred twenty-three cases to four hundred eighty-seven.\"\n\nBefore: \"• Housing permits dropped 25%\"\nAfter: \"On the housing front, permits dropped twenty-five percent.\"\n\nBefore: \"See chart below for trends [CHART:time_series:123]\"\nAfter: \"The data shows a clear upward trend over the past six months.\"\n\nOriginal Newsletter Content:\n{newsletter_content}\n\nReturn only the transformed audio script - no additional formatting, explanations, or metadata. The script should be ready to send directly to a text-to-speech service."
    }
  }
}