<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anomaly Chart | TransparentSF</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Plotly.js for visualizations -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --spruce-green: #4A7463;
            --soft-sand: #F6F1EA;
            --warm-coral: #FF6B5A;
            --sky-blue: #71B2CA;
            --ink-black: #222222;
        }
        
        body {
            font-family: 'IBM Plex Sans', Arial, sans-serif;
            color: var(--ink-black);
            background-color: white;
            padding: 15px;
            font-size: 14px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .row {
            display: flex;
            justify-content: center;
            margin: 0 auto;
        }
        
        .col-12 {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            margin: 0 auto;
            box-shadow: none;
            overflow: visible;
            position: relative;
            display: block;
            width: 100%;
            max-width: 600px;
            border: none;
            box-sizing: border-box;
        }
        
        /* Add corner shading elements */
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 61.8%;
            height: 61.8%;
            border-top: 2px solid rgba(0, 0, 0, 0.2);
            border-right: 2px solid rgba(0, 0, 0, 0.2);
            border-top-right-radius: 8px;
            display: block;
            pointer-events: none;
        }
        
        .chart-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 61.8%;
            height: 61.8%;
            border-bottom: 2px solid rgba(0, 0, 0, 0.2);
            border-left: 2px solid rgba(0, 0, 0, 0.2);
            border-bottom-left-radius: 8px;
            display: block;
            pointer-events: none;
        }
        
        .header {
            color: var(--spruce-green);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 250px;
            color: var(--spruce-green);
        }
        
        .error-message {
            color: var(--warm-coral);
            padding: 12px;
            background-color: rgba(255, 107, 90, 0.1);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .metadata {
            background-color: rgba(246, 241, 234, 0.7);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .chart-caption {
            font-size: 11px;
            padding: 6px;
            background-color: rgba(246, 241, 234, 0.7);
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .badge {
            background-color: var(--spruce-green);
            color: white;
            font-weight: normal;
            padding: 3px 8px;
            font-size: 0.75rem;
        }
        
        .positive-change {
            color: var(--spruce-green);
        }
        
        .negative-change {
            color: var(--warm-coral);
        }
        
        /* Ensure Plotly elements are responsive */
        .js-plotly-plot, .plot-container {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 6px;
        }
        
        .main-svg {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .chart-container {
                padding: 8px;
            }
            
            .metadata {
                padding: 10px;
            }
            
            .mt-3.d-flex {
                flex-direction: column;
            }
            
            .mt-3.d-flex .btn {
                margin: 5px 0;
                width: 100%;
            }
            
            #anomaly-chart {
                padding-bottom: 100%; /* Maintain square aspect ratio on very small screens */
            }
        }
        
        /* Add media query for wider screens */
        @media (min-width: 768px) {
            #anomaly-chart {
                padding-bottom: 75%; /* Maintain 4:3 aspect ratio on wider screens */
            }
        }
        
        @media (min-width: 1200px) {
            #anomaly-chart {
                padding-bottom: 75%; /* Maintain 4:3 aspect ratio on very wide screens */
            }
        }
        
        /* Special handling for small embedded windows */
        @media (max-height: 500px) {
            #anomaly-chart {
                padding-bottom: 60%; /* Even shorter for very small height windows */
            }
            
            .chart-container {
                padding: 5px;
            }
        }
        
        /* Special handling for very small embedded windows (like 437x437) */
        @media (max-width: 450px) and (max-height: 450px) {
            #anomaly-chart {
                padding-bottom: 55%; /* Even more compact for very small windows */
            }
            
            .chart-container {
                padding: 3px;
                max-width: 100%;
            }
            
            body {
                padding: 5px;
            }
        }
        
        /* Ensure the container takes full height in chart section mode */
        body.chart-section-mode {
            margin: 0;
            padding: 0;
            height: auto;
            min-height: auto;
            background-color: transparent;
            overflow: hidden;
        }
        
        body.chart-section-mode .container {
            padding: 0;
            margin: 0;
            width: 100%;
            max-width: none;
            height: auto;
        }
        
        body.chart-section-mode .row,
        body.chart-section-mode .col-12 {
            margin: 0;
            padding: 0;
            width: 100%;
            max-width: none;
            height: auto;
        }
        
        body.chart-section-mode .chart-container {
            margin: 0;
            box-shadow: none;
            width: 100%;
            max-width: none;
            height: auto;
        }
        
/* 
        body.chart-section-mode #chart-section::before,
        body.chart-section-mode #chart-section::after {
            display: none;
        }
*/
        
        /* Ensure the modebar is hidden with CSS as well */
        .modebar {
            display: none !important;
        }
        
        /* Ensure chart is responsive and contains text properly */
        .square-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .square-container:before {
            content: "";
            display: block;
            padding-top: 75%; /* Changed from 100% to 75% for 4:3 aspect ratio */
        }
        
        .square-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* Ensure text wraps properly */
        .annotation-text {
            white-space: normal !important;
            overflow-wrap: break-word !important;
            word-wrap: break-word !important;
        }
        
        #anomaly-chart {
            width: 100%;
            height: 0;
            padding-bottom: 75%; /* Changed from 100% to 75% for better fit in 437x437 window */
            position: relative;
            overflow: visible;
            display: block;
            box-sizing: border-box;
        }
        
        #anomaly-plot {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
    </style>

    <!-- Dark Mode CSS -->
    <link rel="stylesheet" href="/static/css/darkmode.css">
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="header">Anomaly Chart</h1>
                
                <!-- Metadata will be displayed here -->
                <div id="metadata" class="metadata"></div>
                
                <!-- Chart container -->
                <div id="chart-section" class="chart-container">
                    <div id="loading" class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="error-message" class="error-message" style="display: none;"></div>
                    <div id="anomaly-chart"></div>
                    <div id="datasf-link" class="mt-3" style="text-align: center;"></div>
                </div>
                
                <div class="mt-3 d-flex justify-content-between flex-column flex-sm-row">
                    <a href="javascript:history.back()" class="btn btn-outline-secondary mb-2 mb-sm-0">Back</a>
                    <div class="d-flex flex-column flex-sm-row">
                        <button id="share-btn" class="btn btn-outline-success mb-2 mb-sm-0 me-sm-2" onclick="copyShareLink()">
                        <i class="fas fa-share-alt me-1"></i> Share
                    </button>
                    <button id="embed-btn" class="btn btn-outline-primary" onclick="showEmbedCode()">
                        <i class="fas fa-code me-1"></i> Embed
                    </button>
                    </div>
                </div>
                
                <!-- Embed code modal -->
                <div class="modal fade" id="embedModal" tabindex="-1" aria-labelledby="embedModalLabel" inert>
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="embedModalLabel">Embed Chart</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Copy and paste this code into your website or article:</p>
                                <div class="input-group mb-3">
                                    <textarea id="embedCode" class="form-control" rows="3" readonly></textarea>
                                    <button class="btn btn-outline-primary" type="button" onclick="copyEmbedCode()">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="responsiveCheck" checked>
                                    <label class="form-check-label" for="responsiveCheck">
                                        Make responsive
                                    </label>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="widthInput">Width:</label>
                                    <input type="text" class="form-control" id="widthInput" value="100%">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="heightInput">Height:</label>
                                    <input type="text" class="form-control" id="heightInput" value="600px">
                                </div>
                                <button class="btn btn-primary" onclick="updateEmbedCode()">Update Code</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const anomalyId = urlParams.get('id');
        const fullView = urlParams.get('full_view') === 'true';
        
        // Elements
        const loadingEl = document.getElementById('loading');
        const errorMessageEl = document.getElementById('error-message');
        const metadataEl = document.getElementById('metadata');
        
        // Function to show loading state
        function showLoading() {
            loadingEl.style.display = 'flex';
            errorMessageEl.style.display = 'none';
        }
        
        // Function to show error message
        function showError(message) {
            loadingEl.style.display = 'none';
            errorMessageEl.style.display = 'block';
            errorMessageEl.textContent = message;
        }
        
        // Function to hide loading state
        function hideLoading() {
            loadingEl.style.display = 'none';
        }
        
        // Function to update chart aspect ratio
        function updateChartAspectRatio() {
            const chartContainer = document.getElementById('chart-section');
            const anomalyChart = document.getElementById('anomaly-chart');
            const plotElement = document.getElementById('anomaly-plot');
            
            if (!chartContainer || !anomalyChart || !plotElement) return;
            
            // For embedded mode (chart-section-mode)
            if (document.body.classList.contains('chart-section-mode')) {
                // Style container for embedded view
                chartContainer.style.maxWidth = '600px';
                chartContainer.style.margin = '0 auto';
                
                // Ensure aspect ratio is square
                const containerWidth = Math.min(window.innerWidth, 600);
                chartContainer.style.width = containerWidth + 'px';
                chartContainer.style.height = containerWidth + 'px';
            } else {
                // For full view mode
                // Calculate available width up to 600px maximum
                const availableWidth = Math.min(chartContainer.parentElement.clientWidth, 600);
                chartContainer.style.width = availableWidth + 'px';
                chartContainer.style.height = availableWidth + 'px';
                chartContainer.style.maxWidth = '600px';
                chartContainer.style.maxHeight = '600px';
            }
            
            // Make sure the plot fills its container
            if (plotElement) {
                plotElement.style.width = '100%';
                plotElement.style.height = '100%';
                Plotly.Plots.resize(plotElement);
            }
        }

        // Add window resize handler for responsiveness
        window.addEventListener('resize', updateChartAspectRatio);
        
        // Initial call to set aspect ratio
        updateChartAspectRatio();

        // Function to handle chart section visibility
        function handleChartSection() {
            const isChartSection = !fullView || window.location.hash === '#chart-section';
            const header = document.querySelector('.header');
            const metadata = document.getElementById('metadata');
            const buttons = document.querySelector('.mt-3');
            const embedModal = document.getElementById('embedModal');
            const datasfLink = document.getElementById('datasf-link');
            const shareBtn = document.getElementById('share-btn');
            const embedBtn = document.getElementById('embed-btn');
            const backButton = document.querySelector('a[href="javascript:history.back()"]');
            
            // Add or remove chart-section-mode class on body
            document.body.classList.toggle('chart-section-mode', isChartSection);
            
            if (isChartSection) {
                // Hide non-chart elements
                if (header) header.style.display = 'none';
                if (metadata) metadata.style.display = 'none';
                if (buttons) buttons.style.display = 'none';
                if (embedModal) embedModal.style.display = 'none';
                if (datasfLink) datasfLink.style.display = 'none';
                if (shareBtn) shareBtn.style.display = 'none';
                if (embedBtn) embedBtn.style.display = 'none';
                if (backButton) backButton.style.display = 'none';
                
                // Set chart container to maintain aspect ratio
                const chartContainer = document.getElementById('chart-section');
                if (chartContainer) {
                    chartContainer.style.margin = '0 auto';
                    chartContainer.style.maxWidth = '100%'; // Changed from 600px to 100%
                    chartContainer.style.width = '100%';
                    chartContainer.style.display = 'flex';
                    chartContainer.style.justifyContent = 'center';
                    chartContainer.style.alignItems = 'center';
                    
                    // Add permalink button to chart section
                    let permalinkBtn = document.getElementById('chart-section-permalink');
                    if (!permalinkBtn) {
                        permalinkBtn = document.createElement('button');
                        permalinkBtn.id = 'chart-section-permalink';
                        permalinkBtn.className = 'btn btn-sm btn-link';
                        permalinkBtn.style.position = 'absolute';
                        permalinkBtn.style.bottom = '5px';
                        permalinkBtn.style.right = '5px';
                        permalinkBtn.style.zIndex = '1000';
                        permalinkBtn.style.fontSize = '10px';
                        permalinkBtn.style.color = '#888888';
                        permalinkBtn.style.textDecoration = 'none';
                        permalinkBtn.style.border = 'none';
                        permalinkBtn.style.background = 'none';
                        permalinkBtn.style.padding = '0';
                        permalinkBtn.style.cursor = 'pointer';
                        permalinkBtn.innerHTML = '<i class="fas fa-share-alt me-1"></i>Share';
                        permalinkBtn.onclick = function() {
                            const fullUrl = window.location.href.split('#')[0];
                            if (navigator.share) {
                                navigator.share({
                                    title: 'TransparentSF Chart',
                                    text: 'Check out this chart from TransparentSF',
                                    url: fullUrl
                                }).catch(err => {
                                    console.error('Error sharing:', err);
                                    // Fallback to copying to clipboard
                                    copyToClipboard(fullUrl);
                                });
                            } else {
                                // Fallback to copying to clipboard
                                copyToClipboard(fullUrl);
                            }
                        };
                        chartContainer.appendChild(permalinkBtn);
                    }
                    
                    // Add full view button if it doesn't exist
                    let fullViewBtn = document.getElementById('full-view-btn');
                    if (!fullViewBtn) {
                        fullViewBtn = document.createElement('button');
                        fullViewBtn.id = 'full-view-btn';
                        fullViewBtn.className = 'btn btn-sm btn-link';
                        fullViewBtn.style.position = 'absolute';
                        fullViewBtn.style.bottom = '5px';
                        fullViewBtn.style.left = '5px';
                        fullViewBtn.style.zIndex = '1000';
                        fullViewBtn.style.fontSize = '10px';
                        fullViewBtn.style.color = '#888888';
                        fullViewBtn.style.textDecoration = 'none';
                        fullViewBtn.style.border = 'none';
                        fullViewBtn.style.background = 'none';
                        fullViewBtn.style.padding = '0';
                        fullViewBtn.style.cursor = 'pointer';
                        fullViewBtn.innerHTML = '<i class="fas fa-expand me-1"></i>Full View';
                        fullViewBtn.onclick = function() {
                            const baseUrl = window.location.href.split('#')[0]; // Get URL without hash
                            const currentUrl = new URL(baseUrl);
                            currentUrl.searchParams.set('full_view', 'true');
                            window.open(currentUrl.toString(), '_blank');
                        };
                        chartContainer.appendChild(fullViewBtn);
                    }
                }
                
                // Hide the chart caption
                const chartCaption = document.querySelector('.chart-caption');
                if (chartCaption) {
                    chartCaption.style.display = 'none';
                }
                
                // Update chart size to fit container
                const plotElement = document.getElementById('anomaly-plot');
                if (plotElement) {
                    Plotly.Plots.resize(plotElement);
                }
                
                // Send chart height to parent window
                const sendHeight = () => {
                    const chartElement = document.getElementById('anomaly-chart');
                    if (chartElement) {
                        // Calculate height based on the 4:3 aspect ratio
                        const width = chartElement.offsetWidth;
                        const height = width * 0.75; // 3/4 = 0.75
                        window.parent.postMessage({
                            type: 'chartHeight',
                            height: height
                        }, '*'); // Changed from window.location.origin to '*' to allow embedding on different origins
                    }
                };
                
                // Send height initially and after any changes
                sendHeight();
                const observer = new ResizeObserver(sendHeight);
                const chartElement = document.getElementById('anomaly-chart');
                if (chartElement) {
                    observer.observe(chartElement);
                }
            } else {
                // Show all elements
                if (header) header.style.display = 'block';
                if (metadata) metadata.style.display = 'block';
                if (buttons) buttons.style.display = 'block';
                if (embedModal) embedModal.style.display = 'block';
                if (datasfLink) datasfLink.style.display = 'block';
                if (shareBtn) shareBtn.style.display = 'block';
                if (embedBtn) embedBtn.style.display = 'block';
                if (backButton) backButton.style.display = 'block';
                
                // Remove permalink button if it exists
                const permalinkBtn = document.getElementById('chart-section-permalink');
                if (permalinkBtn) {
                    permalinkBtn.remove();
                }
                
                // Remove full view button if it exists
                const fullViewBtn = document.getElementById('full-view-btn');
                if (fullViewBtn) {
                    fullViewBtn.remove();
                }
                
                // Show the chart caption
                const chartCaption = document.querySelector('.chart-caption');
                if (chartCaption) {
                    chartCaption.style.display = 'block';
                }
                
                // Reset chart container styles
                const chartContainer = document.getElementById('chart-section');
                if (chartContainer) {
                    chartContainer.style.margin = '';
                    chartContainer.style.maxWidth = '';
                    chartContainer.style.width = '';
                    chartContainer.style.display = '';
                    chartContainer.style.justifyContent = '';
                    chartContainer.style.alignItems = '';
                }
            }
        }

        // Handle initial load and hash changes
        handleChartSection();
        window.addEventListener('hashchange', handleChartSection);

        // Function to copy text to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const permalinkBtn = document.getElementById('chart-section-permalink');
                if (permalinkBtn) {
                    const originalHtml = permalinkBtn.innerHTML;
                    permalinkBtn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                    setTimeout(() => {
                        permalinkBtn.innerHTML = originalHtml;
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // Function to copy the current URL to clipboard
        function copyShareLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const shareBtn = document.getElementById('share-btn');
                const originalText = shareBtn.innerHTML;
                
                // Change button text to indicate success
                shareBtn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
                shareBtn.classList.remove('btn-outline-success');
                shareBtn.classList.add('btn-success');
                
                // Change back after 2 seconds
                setTimeout(() => {
                    shareBtn.innerHTML = originalText;
                    shareBtn.classList.remove('btn-success');
                    shareBtn.classList.add('btn-outline-success');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy the link. Please try again.');
            });
        }

        // Function to show the embed code modal
        function showEmbedCode() {
            // Generate the initial embed code
            updateEmbedCode();
            
            // Show the modal
            const embedModal = document.getElementById('embedModal');
            embedModal.removeAttribute('inert');
            const modal = new bootstrap.Modal(embedModal);
            modal.show();
        }

        // Function to update the embed code
        function updateEmbedCode() {
            const width = document.getElementById('widthInput').value;
            const height = document.getElementById('heightInput').value;
            const isResponsive = document.getElementById('responsiveCheck').checked;
            
            let embedCode = `<iframe src="${window.location.href.split('#')[0].split('?')[0]}?id=${anomalyId}"`;
            
            if (isResponsive) {
                embedCode += ` style="width: 100%; height: 100%; border: none;"`;
            } else {
                embedCode += ` width="${width}" height="${height}" style="border: none;"`;
            }
            
            embedCode += ` frameborder="0" scrolling="no"></iframe>`;
            
            if (isResponsive) {
                // Use 4:3 aspect ratio (75%) for responsive charts
                embedCode = `<div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">\n  <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">\n    ${embedCode}\n  </div>\n</div>`;
            }
            
            document.getElementById('embedCode').value = embedCode;
        }

        // Function to copy the embed code to clipboard
        function copyEmbedCode() {
            const embedCode = document.getElementById('embedCode');
            embedCode.select();
            document.execCommand('copy');
            
            // Show a brief success message
            const copyBtn = document.querySelector('#embedModal .btn-outline-primary');
            const originalHtml = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
            
            setTimeout(() => {
                copyBtn.innerHTML = originalHtml;
            }, 2000);
        }

        // Add event listener to handle modal closing
        document.addEventListener('DOMContentLoaded', function() {
            const embedModal = document.getElementById('embedModal');
            embedModal.addEventListener('hidden.bs.modal', function() {
                embedModal.setAttribute('inert', '');
            });
        });

        // Function to fetch anomaly data
        async function fetchAnomalyData() {
            // Check if anomaly ID is provided
            if (!anomalyId) {
                showError('No anomaly ID provided. Please specify an anomaly ID in the URL.');
                return;
            }
            
            try {
                // Show loading indicator
                showLoading();
                
                // Fetch anomaly details
                console.log(`Fetching anomaly data for ID: ${anomalyId}`);
                const response = await fetch(`/anomaly-analyzer/api/anomaly-details/${anomalyId}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch anomaly data: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log("Received data:", data);
                
                if (data.status === 'error') {
                    throw new Error(data.message || 'Failed to load anomaly data');
                }
                
                if (!data.anomaly) {
                    throw new Error('Response is missing anomaly data');
                }
                
                // Render the chart
                renderAnomalyChart(data);
                
            } catch (error) {
                console.error('Error fetching anomaly data:', error);
                hideLoading();
                showError(`Error loading anomaly data: ${error.message}`);
            }
        }

        // Function to render the anomaly chart
        function renderAnomalyChart(data) {
            console.log("Rendering anomaly chart for data:", data);
            
            // Check if we have valid data
            if (!data || !data.anomaly || !data.anomaly.chart_data) {
                showError('Invalid or incomplete anomaly data received.');
                return;
            }
            
            // Extract data from the API response
            const anomaly = data.anomaly;
            const chartData = anomaly.chart_data;
            const metadata = anomaly.metadata || {};
            
            // Hide loading indicator
            hideLoading();
            
            // Create a container for the chart
            const chartElement = document.getElementById('anomaly-chart');
            chartElement.innerHTML = ''; // Clear existing content
            
            // Create a new div for the actual chart
            const plotDiv = document.createElement('div');
            plotDiv.id = 'anomaly-plot';
            plotDiv.style.width = '100%';
            plotDiv.style.height = '100%';
            chartElement.appendChild(plotDiv);
            
            // Process chart data
            const recentDates = [];
            const recentValues = [];
            const comparisonDates = [];
            const comparisonValues = [];
            
            // Process chart data based on periods
            if (chartData.dates && chartData.values && chartData.periods) {
                for (let i = 0; i < chartData.dates.length; i++) {
                    const dateStr = chartData.dates[i];
                    const value = chartData.values[i];
                    const period = chartData.periods[i];
                    
                    // Parse the date string into a Date object
                    let dateObj;
                    try {
                        // Check if this is a weekly format (YYYY-WXX)
                        if (dateStr.includes('W') && dateStr.includes('-')) {
                            const [yearPart, weekPart] = dateStr.split('-');
                            const year = parseInt(yearPart);
                            const weekNum = parseInt(weekPart.replace('W', ''));
                            
                            // Create a date for the first day of the year
                            const jan1 = new Date(year, 0, 1);
                            
                            // Find the first Monday of the year (ISO week starts on Monday)
                            // If Jan 1 is Monday (weekday=0), we're good. Otherwise, find the next Monday
                            const daysUntilMonday = (7 - jan1.getDay()) % 7;
                            const firstMonday = new Date(jan1.getTime() + daysUntilMonday * 24 * 60 * 60 * 1000);
                            
                            // Calculate the target date by adding weeks
                            dateObj = new Date(firstMonday.getTime() + (weekNum - 1) * 7 * 24 * 60 * 60 * 1000);
                        } else {
                            // Handle regular date formats
                            const dateParts = dateStr.split('-');
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const day = dateParts.length > 2 ? parseInt(dateParts[2]) : 1;
                            dateObj = new Date(year, month, day);
                        }
                        
                        if (isNaN(dateObj.getTime())) {
                            console.error(`Invalid date: ${dateStr}`);
                            continue;
                        }
                        
                        // Add to appropriate arrays based on period
                        if (period === 'recent') {
                            recentDates.push(dateObj);
                            recentValues.push(value);
                        } else if (period === 'comparison') {
                            comparisonDates.push(dateObj);
                            comparisonValues.push(value);
                        }
                    } catch (e) {
                        console.error(`Error parsing date: ${dateStr}`, e);
                    }
                }
            }
            
            // Create traces for the chart
            const traces = [];
            
            // Add normal range shaded area if we have comparison data
            if (comparisonDates.length > 0) {
                const allDates = [...comparisonDates, ...recentDates].sort((a, b) => a - b);
                const upperBound = allDates.map(() => anomaly.comparison_mean + 2 * anomaly.std_dev);
                const lowerBound = allDates.map(() => Math.max(anomaly.comparison_mean - 2 * anomaly.std_dev, 0));
                
                // Add lower bound trace (invisible)
                traces.push({
                    x: allDates,
                    y: lowerBound,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'rgba(0,0,0,0)' },
                    showlegend: false
                });
                
                // Add normal range area
                traces.push({
                    x: allDates,
                    y: upperBound,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'rgba(74, 116, 99, 0.3)', width: 1 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(74, 116, 99, 0.15)', // Spruce Green with transparency
                    name: 'Normal Range',
                    showlegend: true
                });
            }
            
            // Add comparison period trace
            if (comparisonDates.length > 0) {
                traces.push({
                    x: comparisonDates,
                    y: comparisonValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Historical Data',
                    line: { color: '#ad35fa', width: 2 }, // Bright Blue
                    marker: { color: '#ad35fa', size: 6 }, // Bright Blue
                    showlegend: true,
                    hovertemplate: anomaly.period_type === 'week' ? '%{x|%B %d, %Y}<br>%{y}<extra></extra>' : '%{x|%B %Y}<br>%{y}<extra></extra>'
                });
            }
            
            // Add recent period trace
            if (recentDates.length > 0) {
                traces.push({
                    x: recentDates,
                    y: recentValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Recent Data',
                    line: { color: '#ad35fa', width: 2 }, // Same color as historical
                    marker: { color: '#ad35fa', size: 6 }, // Same color as historical
                    showlegend: true,
                    hovertemplate: anomaly.period_type === 'week' ? '%{x|%B %d, %Y}<br>%{y}<extra></extra>' : '%{x|%B %Y}<br>%{y}<extra></extra>'
                });
            }
            
            // Add connecting line between last historical and first recent point
            if (comparisonDates.length > 0 && recentDates.length > 0) {
                const lastHistoricalDate = comparisonDates[comparisonDates.length - 1];
                const lastHistoricalValue = comparisonValues[comparisonValues.length - 1];
                const firstRecentDate = recentDates[0];
                const firstRecentValue = recentValues[0];
                
                traces.push({
                    x: [lastHistoricalDate, firstRecentDate],
                    y: [lastHistoricalValue, firstRecentValue],
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#ad35fa', width: 2, dash: 'dot' }, // Dotted line in same color
                    showlegend: false
                });
            }
            
            // Get the metric name from metadata
            const objectName = metadata.object_name || anomaly.field_name || 'Value';
            
            // Create subtitle with group if present
            let subtitleText = '';
            if (anomaly.group_field_name && anomaly.group_value) {
                subtitleText = `<i>${anomaly.group_field_name}</i>: <b>${anomaly.group_value}</b>`;
            }

            // Add spike/drop information
            const percentChange = anomaly.percent_change || 0;
            const changeType = percentChange > 0 ? 'Spike' : 'Drop';
            const changeText = `${changeType} in ${subtitleText}`;

            // Combine title and subtitle - FLIPPED ORDER
            const combinedTitleText = `${changeText}<br><span style="font-size: 0.8em;">${objectName}</span>`;

            // Configuration for the plot
            const layout = {
                title: {
                    text: combinedTitleText,
                    font: {
                        family: 'Inter, Arial, sans-serif',
                        size: 14,
                        color: '#222222'
                    },
                    y: 0.98,
                    x: 0.5,
                    xanchor: 'center',
                    pad: { t: 10, b: 10 }
                },
                annotations: [
                    // The original annotation for changeText (annotations[0]) is removed.
                    // If other annotations existed, their indices would shift.
                ],
                xaxis: {
                    title: {
                        text: '',
                        font: { 
                            family: 'IBM Plex Sans, Arial, sans-serif',
                            size: 10,
                            color: '#222222'
                        }
                    },
                    showgrid: false,
                    tickformat: anomaly.period_type === 'week' ? '%b %d, %Y' : '%b %Y',
                    tickfont: { 
                        family: 'IBM Plex Sans, Arial, sans-serif',
                        size: 9,
                        color: '#222222'
                    },
                    tickmode: 'array',
                    tickvals: [...comparisonDates, ...recentDates].sort((a, b) => a - b),
                    ticktext: [...comparisonDates, ...recentDates].sort((a, b) => a - b).map((d, index) => {
                        const month = d.getMonth();
                        const year = d.getFullYear();
                        const day = d.getDate();
                        const fullMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        
                        if (anomaly.period_type === 'week') {
                            // For weekly data, show month and day
                            let label = `${fullMonths[month].substring(0, 3)} ${day}`;
                            
                            if (index === 0 || [...comparisonDates, ...recentDates].sort((a, b) => a - b)[index - 1].getFullYear() !== year) {
                                label += `<br>${year}`;
                            } else {
                                label += "<br> ";
                            }
                            
                            return label;
                        } else {
                            // For monthly/yearly data, show month abbreviation
                            let label = fullMonths[month].charAt(0);
                            
                            if (index === 0 || [...comparisonDates, ...recentDates].sort((a, b) => a - b)[index - 1].getFullYear() !== year) {
                                label += `<br>${year}`;
                            } else {
                                label += "<br> ";
                            }
                            
                            return label;
                        }
                    }),
                    tickangle: 0,
                    ticklen: 3,
                    tickcolor: '#222222',
                    showline: true,
                    linecolor: '#e5e7eb',
                    linewidth: 1,
                    tickpadding: 10
                },
                yaxis: {
                    title: {
                        text: metadata.y_axis_label || anomaly.field_name || "Value",
                        font: { 
                            family: 'IBM Plex Sans, Arial, sans-serif',
                            size: 10,
                            color: '#222222'
                        }
                    },
                    showgrid: true,
                    gridcolor: 'rgba(232, 233, 235, 0.5)',
                    zeroline: false,
                    rangemode: 'tozero',
                    tickfont: { 
                        family: 'IBM Plex Sans, Arial, sans-serif',
                        size: 9,
                        color: '#222222'
                    }
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    y: -0.12,
                    xanchor: 'center',
                    yanchor: 'top',
                    font: { 
                        family: 'IBM Plex Sans, Arial, sans-serif',
                        size: 9,
                        color: '#222222'
                    },
                    bgcolor: 'rgba(246, 241, 234, 0.7)'
                },
                margin: { t: 60, b: 30, l: 50, r: 30 },
                height: null,
                width: null,
                autosize: true,
                paper_bgcolor: 'rgba(255, 255, 255, 0.9)',
                plot_bgcolor: 'rgba(255, 255, 255, 0.9)',
                hovermode: 'closest',
                hoverlabel: {
                    bgcolor: '#F6F1EA',
                    bordercolor: '#4A7463',
                    font: { 
                        family: 'IBM Plex Sans, Arial, sans-serif',
                        size: 9,
                        color: '#222222'
                    }
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: false,
                modeBarButtonsToRemove: ['toImage', 'pan2d', 'zoom2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian', 'lasso2d', 'select2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'anomaly_chart',
                    scale: 2
                }
            };
            
            // Create the plot
            Plotly.newPlot('anomaly-plot', traces, layout, config).then(() => {
                // Update chart dimensions
                updateChartAspectRatio();
                
                // Display metadata
                displayMetadata(anomaly);

                // Apply initial theme colors
                applyThemeToPlot(document.documentElement.getAttribute('data-theme') || 'light');
            });
            
            // Add responsive resize handler to update layout on window resize
            function resizePlot() {
                const plotElement = document.getElementById('anomaly-plot');
                if (!plotElement) return;
                
                // Get the current dimensions
                const chartWidth = plotElement.clientWidth;
                
                // Adjust title and annotation font sizes based on chart width
                let update = {
                    'title.font.size': Math.max(12, Math.min(14, chartWidth / 30)),
                    'legend.font.size': Math.max(8, Math.min(9, chartWidth / 45))
                };
                
                // For very small screens, adjust vertical positioning
                if (chartWidth < 400) {
                    update['title.y'] = 0.98;
                    update['legend.y'] = -0.10;
                    update['margin.b'] = 55;
                    update['margin.t'] = 60;
                }
                
                // Apply the updates
                Plotly.relayout(plotElement, update);
            }
        }
        
        // Function to display metadata
        function displayMetadata(anomaly) {
            // Get metadata fields
            const metadata = anomaly.metadata || {};
            const metricName = metadata.object_name || anomaly.field_name || 'Unknown Metric';
            const district = anomaly.district === 0 ? 'Citywide' : `District ${anomaly.district}`;
            
            // Format the date properly
            let recentPeriod = 'Unknown Period';
            if (anomaly.recent_date) {
                const dateParts = anomaly.recent_date.split('-');
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]) - 1;
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                recentPeriod = `${months[month]} ${year}`;
            }
            
            // Format percent change with direction
            const percentChange = anomaly.percent_change || 0;
            const changeDirection = percentChange > 0 ? 'increase' : percentChange < 0 ? 'decrease' : 'no change';
            const changeClass = percentChange > 0 ? 'positive-change' : 'negative-change';
            
            // Create HTML for metadata
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h5>${metricName}</h5>
                        <p><strong>District:</strong> ${district}</p>
                        <p><strong>Period:</strong> ${recentPeriod}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Recent Value:</strong> ${formatValue(anomaly.recent_mean)}</p>
                        <p><strong>Historical Value:</strong> ${formatValue(anomaly.comparison_mean)}</p>
                        <p><strong>Change:</strong> <span class="${changeClass}">${formatValue(anomaly.difference)} (${Math.abs(percentChange).toFixed(2)}% ${changeDirection})</span></p>
                    </div>
                </div>
            `;
            
            // Set HTML
            metadataEl.innerHTML = html;
        }

        // Function to format values for display
        function formatValue(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return parseFloat(value).toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }
        
        // Load data when the page loads
        document.addEventListener('DOMContentLoaded', fetchAnomalyData);

        // Function to apply theme colors to Plotly chart
        function applyThemeToPlot(theme) {
            const isDark = theme === 'dark';
            const styles = getComputedStyle(document.documentElement);
            const textColor = styles.getPropertyValue('--text-primary').trim() || (isDark ? '#ffffff' : '#222222');
            const gridColor = isDark ? 'rgba(60,60,60,0.5)' : 'rgba(232, 233, 235, 0.5)';
            const borderColor = styles.getPropertyValue('--border-primary').trim() || gridColor;
            const paperBg = styles.getPropertyValue('--bg-primary').trim() || (isDark ? '#121212' : '#ffffff');

            Plotly.relayout('anomaly-plot', {
                'font.color': textColor,
                'xaxis.tickfont.color': textColor,
                'xaxis.linecolor': borderColor,
                'yaxis.title.font.color': textColor,
                'yaxis.tickfont.color': textColor,
                'yaxis.gridcolor': gridColor,
                'legend.font.color': textColor,
                'title.font.color': textColor,
                'paper_bgcolor': paperBg,
                'plot_bgcolor': paperBg
            });
        }

        // Listen for dark-mode changes dispatched by DarkModeManager
        window.addEventListener('themeChanged', (e) => {
            if (e && e.detail && e.detail.theme) {
                applyThemeToPlot(e.detail.theme);
            }
        });
    </script>

    <!-- Dark Mode JavaScript -->
    <script src="/static/js/darkmode.js"></script>
    <script src="/static/js/iframe-darkmode.js"></script>
</body>
</html> 