<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metric Change Analyzer | Transparent SF</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap">
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Markdown-it for rendering markdown -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@12.3.2/dist/markdown-it.min.js"></script>
    <link rel="stylesheet" href="/static/darkmode.css">
    <script src="/static/js/darkmode.js"></script>
    <script src="/static/js/iframe-darkmode.js"></script>
    <style>
        /* Override some variables for this specific template */
        :root {
            --civic-blue: #2C5282;
            --civic-blue-light: #4299E1;
            --civic-blue-lighter: #EBF8FF;
            --warm-coral: #F56565;
            --warm-coral-light: #FEB2B2;
            --neutral-gray: #4A5568;
            --neutral-gray-light: #E2E8F0;
            --neutral-gray-lighter: #F7FAFC;
            --background: var(--bg-primary);
            --success: #48BB78;
            --error: #F56565;
            --text-primary: #222222;
            --text-secondary: #666666;
            --shadow: 0 4px 6px var(--shadow-light);
            --glass-effect: var(--bg-primary);
        }
        
        [data-theme="dark"] {
            --civic-blue: #4299E1;
            --civic-blue-light: #63B3ED;
            --civic-blue-lighter: #1A365D;
            --warm-coral: #F56565;
            --warm-coral-light: #FEB2B2;
            --neutral-gray: #A0AEC0;
            --neutral-gray-light: #2D3748;
            --neutral-gray-lighter: #1A202C;
            --background: var(--bg-primary);
            --success: #48BB78;
            --error: #F56565;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --shadow: 0 4px 6px var(--shadow-light);
            --glass-effect: var(--bg-primary);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0;
            padding: 0;
            font-size: 14px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overflow-y: auto;
        }
        
        .header {
            background-color: var(--civic-blue);
            color: white;
            padding: 16px 24px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            font-family: 'Inter', sans-serif;
        }
        
        .header-title span {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, #FFFFFF 0%, rgba(255, 255, 255, 0.85) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        [data-theme="dark"] .header-title span {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header .logo-box {
            background-color: white;
            color: var(--civic-blue);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 12px;
        }
        

        
        .main-container {
            display: flex;
            flex-direction: column;
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            overflow-y: auto;
        }
        
        .controls {
            display: flex;
            margin-bottom: 20px;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            background-color: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }
        
        [data-theme="dark"] .controls {
            background-color: var(--bg-secondary);
            border-color: var(--border-primary);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] label {
            color: var(--text-primary);
        }
        
        select, button, input {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-primary);
            font-size: 14px;
            font-family: 'IBM Plex Sans', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--civic-blue-light);
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
        }
        
        button {
            background-color: #ad35fa;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #0069d9;
            transform: translateY(-1px);
        }
        
        [data-theme="dark"] button {
            background-color: #c44dff;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="dark"] button:hover {
            background-color: #d966ff;
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        button.secondary {
            background-color: var(--bg-secondary);
            color: #ad35fa;
            border: 1px solid #ad35fa;
        }
        
        button.secondary:hover {
            background-color: var(--bg-tertiary);
        }
        
        [data-theme="dark"] button.secondary {
            background-color: var(--bg-secondary);
            color: #c44dff;
            border: 1px solid #c44dff;
        }
        
        [data-theme="dark"] button.secondary:hover {
            background-color: var(--bg-tertiary);
            border-color: #d966ff;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        
        .metrics-panel {
            background-color: white;
            border-radius: 8px;
            margin-bottom: 24px;
            width: 100%;
        }
        
        [data-theme="dark"] .metrics-panel {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
        }
        
        .metrics-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--neutral-gray-light);
        }
        
        .metrics-header h2 {
            font-family: 'Inter', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--civic-blue);
            margin: 0;
        }
        
        .metrics-header p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        [data-theme="dark"] .metrics-header h2 {
            color: var(--civic-blue);
        }
        
        [data-theme="dark"] .metrics-header p {
            color: var(--text-primary);
        }
        
        .metrics-table-container {
            flex: 1;
            padding: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--neutral-gray-light);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] th, 
        [data-theme="dark"] td {
            color: var(--text-primary);
            border-bottom-color: var(--border-primary);
        }
        
        /* Make the metric name column wider */
        th:first-child, td:first-child {
            min-width: 40px;
            max-width: 40px;
            text-align: center;
            padding: 8px 4px;
        }
        
        /* Make the second column (metric name) wider */
        th:nth-child(2), td:nth-child(2) {
            min-width: 250px;
            max-width: 400px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        th {
            background-color: var(--neutral-gray-lighter);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        [data-theme="dark"] th {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] th, 
        [data-theme="dark"] td {
            color: var(--text-primary);
        }
        
        [data-theme="dark"] th {
            color: var(--text-secondary);
        }
        
        tr:hover {
            background-color: rgba(196, 77, 255, 0.1);
        }
        
        [data-theme="dark"] tr:hover {
            background-color: rgba(196, 77, 255, 0.2);
        }
        
        .positive-change {
            color: var(--success);
            font-weight: 500;
        }
        
        .negative-change {
            color: var(--error);
            font-weight: 500;
        }
        
        .neutral-change {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Stale data warning styles */
        .stale-data-warning {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background-color: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
            border: 1px solid #ffeaa7;
            position: relative;
        }
        
        .stale-data-warning i {
            font-size: 10px;
        }
        
        [data-theme="dark"] .stale-data-warning {
            background-color: #2d1b69;
            color: #f39c12;
            border-color: #8e44ad;
        }
        
        /* Enhanced tooltip for stale data warning */
        .stale-data-warning:hover {
            cursor: help;
            background-color: #ffeaa7;
            border-color: #fdcb6e;
        }
        
        [data-theme="dark"] .stale-data-warning:hover {
            background-color: #3d2b79;
            border-color: #9b59b6;
        }
        
        /* Custom tooltip styling */
        .stale-data-warning[title]:hover::after {
            content: attr(title);
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-top: -40px;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        [data-theme="dark"] .stale-data-warning[title]:hover::after {
            background: #1a1a1a;
            border: 1px solid #444;
        }
        
        /* Stale data summary styles */
        .stale-data-summary {
            background-color: #fff3cd;
            border-left: 4px solid #f39c12;
        }
        
        .stale-data-summary-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            color: #856404;
            font-weight: 500;
        }
        
        .stale-data-summary-content i {
            color: #f39c12;
            font-size: 14px;
        }
        
        [data-theme="dark"] .stale-data-summary {
            background-color: #2d1b69;
            border-left-color: #f39c12;
        }
        
        [data-theme="dark"] .stale-data-summary-content {
            color: #f39c12;
        }
        
        [data-theme="dark"] .stale-data-summary-content i {
            color: #f39c12;
        }
        
        .selected-row {
            background-color: var(--civic-blue-lighter) !important;
            border-left: 4px solid var(--civic-blue);
        }
        
        [data-theme="dark"] .selected-row {
            background-color: rgba(196, 77, 255, 0.2) !important;
            border-left: 4px solid #c44dff;
        }
        
        .action-button {
            background-color: var(--bg-secondary);
            color: #ad35fa;
            border: 1px solid #ad35fa;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-button:hover {
            background-color: var(--bg-tertiary);
        }
        
        [data-theme="dark"] .action-button {
            background-color: var(--bg-secondary);
            color: #c44dff;
            border: 1px solid #c44dff;
        }
        
        [data-theme="dark"] .action-button:hover {
            background-color: var(--bg-tertiary);
            border-color: #d966ff;
        }
        
        .add-to-report-btn {
            background-color: var(--bg-secondary);
            color: #ad35fa;
            border: 1px solid #ad35fa;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
        }
        
        .add-to-report-btn:hover {
            background-color: var(--bg-tertiary);
        }
        
        .add-to-report-btn:disabled {
            background-color: var(--bg-secondary);
            color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        
        [data-theme="dark"] .add-to-report-btn {
            background-color: var(--bg-secondary);
            color: #c44dff;
            border: 1px solid #c44dff;
        }
        
        [data-theme="dark"] .add-to-report-btn:hover {
            background-color: var(--bg-tertiary);
            border-color: #d966ff;
        }
        
        [data-theme="dark"] .add-to-report-btn:disabled {
            background-color: var(--bg-secondary);
            color: #6c757d;
            border-color: #6c757d;
        }
        
        .add-to-report-btn.added {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
            cursor: default;
        }
        
        .add-to-report-btn.added:hover {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }
        
        .add-to-report-btn.added {
            animation: addedPulse 0.5s ease-in-out;
        }
        
        @keyframes addedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        [data-theme="dark"] .add-to-report-btn.added {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }
        
        [data-theme="dark"] .add-to-report-btn.added:hover {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }
        
        #analysis-modal,
        #row-details-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .modal-content {
            background-color: var(--background);
            margin: 5% auto;
            padding: 0;
            width: 90%;
            height: 85%;
            border-radius: 8px;
            box-shadow: var(--shadow);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #modal-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            position: relative;
        }
        
        #row-modal-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
            position: relative;
        }
        
        #webchat-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        
        /* Markdown content styling */
        #modal-content {
            font-family: 'IBM Plex Sans', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        #modal-content h1, 
        #modal-content h2, 
        #modal-content h3, 
        #modal-content h4 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: var(--civic-blue);
        }
        
        #modal-content h1 { font-size: 24px; }
        #modal-content h2 { font-size: 20px; }
        #modal-content h3 { font-size: 18px; }
        #modal-content h4 { font-size: 16px; }
        
        #modal-content p {
            margin-bottom: 1em;
        }
        
        #modal-content ul, 
        #modal-content ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        
        #modal-content li {
            margin-bottom: 0.5em;
        }
        
        #modal-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        #modal-content th,
        #modal-content td {
            border: 1px solid var(--neutral-gray-light);
            padding: 8px 12px;
        }
        
        #modal-content th {
            background-color: var(--neutral-gray-lighter);
            font-weight: 600;
        }
        
        #modal-content code {
            background-color: var(--neutral-gray-lighter);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        #modal-content pre {
            background-color: var(--neutral-gray-lighter);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        #modal-content pre code {
            background-color: transparent;
            padding: 0;
        }
        
        #modal-content blockquote {
            border-left: 4px solid var(--civic-blue-light);
            padding-left: 12px;
            margin-left: 0;
            color: var(--text-secondary);
        }
        
        #modal-content img {
            max-width: 100%;
            height: auto;
            margin: 1em 0;
            border-radius: 4px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #f5f5f5;
            color: var(--text-primary);
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--warm-coral-light);
        }
        
        /* New Report Modal Styles */
        #new-report-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        #new-report-modal .modal-content {
            background-color: var(--background);
            margin: 10% auto;
            padding: 0;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #new-report-modal .modal-body {
            padding: 20px;
        }
        
        #new-report-modal .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        #new-report-modal .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        #new-report-modal .primary-btn {
            background-color: #007bff;
            color: white;
        }
        
        #new-report-modal .primary-btn:hover {
            background-color: #0056b3;
        }
        
        #new-report-modal .action-btn:not(.primary-btn) {
            background-color: #6c757d;
            color: white;
        }
        
        #new-report-modal .action-btn:not(.primary-btn):hover {
            background-color: #545b62;
        }
        
        .loader {
            border: 3px solid var(--neutral-gray-light);
            border-top: 3px solid var(--civic-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1.5s linear infinite;
            margin: 30px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .section-header {
            background-color: #f5f5f5;
            color: var(--civic-blue);
            font-weight: 600;
            text-align: center;
            padding: 10px;
            font-family: 'Inter', sans-serif;
            border-bottom: 2px solid #f5f5f5;
        }
        
        .subsection-header {
            background-color: #f5f5f5;
            color: var(--neutral-gray);
            font-weight: 600;
            padding: 8px 15px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            border-bottom: 1px solid #f5f5f5;
        }
        
        [data-theme="dark"] .section-header {
            background-color: var(--bg-tertiary);
            color: var(--civic-blue);
            border-bottom: 2px solid var(--bg-tertiary);
        }
        
        [data-theme="dark"] .subsection-header {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
        }
        

        
        /* Improve spacing between sections */
        .section-header + tr {
            border-top: none;
        }
        
        .subsection-header + tr {
            border-top: none;
        }
        
        .no-data {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 16px;
            background-color: var(--neutral-gray-lighter);
            border-radius: 8px;
            margin: 20px 0;
        }
        
        [data-theme="dark"] .no-data {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }
        
        .error-message {
            background-color: #FFF5F5;
            border-left: 4px solid var(--error);
            padding: 16px 20px;
            margin: 20px 0;
            color: var(--text-primary);
            border-radius: 0 8px 8px 0;
        }
        
        .retry-button {
            background-color: var(--error);
            margin-top: 12px;
        }
        
        .metric-name {
            font-weight: 500;
            color: var(--civic-blue);
        }
        
        [data-theme="dark"] .metric-name {
            color: var(--civic-blue);
        }
        
        .period-indicator {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        [data-theme="dark"] .period-indicator {
            color: var(--text-primary);
        }
        
        .chart-container {
            margin-bottom: 20px;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 20px;
            padding: 15px;
        }
        
        .action-buttons .action-button {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 120px;
        }
        
        .action-buttons .action-button i {
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .button-group {
                margin-left: 0;
                margin-top: 10px;
            }
            
            th, td {
                padding: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .action-button {
                min-width: auto;
            }
        }
        

        

        

        
        /* Main layout */
        .main-container {
            display: flex;
            flex: 1;
            padding: 24px;
            flex-direction: column;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            overflow-y: auto;
            position: relative;
        }
        
        .metrics-panel,
        .metrics-table-container,
        .table,
        .table-responsive,
        .anomaly-chart-container,
        .chart-container {
            box-shadow: none !important;
            background-color: #fff !important;
            border: none !important;
        }
        
        [data-theme="dark"] .metrics-panel,
        [data-theme="dark"] .metrics-table-container,
        [data-theme="dark"] .table,
        [data-theme="dark"] .table-responsive,
        [data-theme="dark"] .anomaly-chart-container,
        [data-theme="dark"] .chart-container {
            background-color: var(--bg-secondary) !important;
        }
        

    </style>
</head>
<body>
    <div class="main-container">
        <div class="controls">
            <div class="control-group">
                <label for="period-select">Time Period</label>
                <select id="period-select">
                    <option value="day">Daily</option>
                    <option value="week">Weekly</option>
                    <option value="month" selected>Monthly</option>
                    <option value="year">Yearly</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="limit-select">Show Top/Bottom</label>
                <select id="limit-select">
                    <option value="5">5 + 5 Changes</option>
                    <option value="10">10 + 10 Changes</option>
                    <option value="25" selected>25 + 25 Changes</option>
                    <option value="50">50 + 50 Changes</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="object-id">Object ID</label>
                <input type="text" id="object-id" placeholder="Optional" value="">
            </div>
            
            <div class="control-group">
                <label for="district">District</label>
                <select id="district">
                    <option value="all">All Districts</option>
                    <option value="0" selected>Citywide</option>
                    <option value="1">District 1</option>
                    <option value="2">District 2</option>
                    <option value="3">District 3</option>
                    <option value="4">District 4</option>
                    <option value="5">District 5</option>
                    <option value="6">District 6</option>
                    <option value="7">District 7</option>
                    <option value="8">District 8</option>
                    <option value="9">District 9</option>
                    <option value="10">District 10</option>
                    <option value="11">District 11</option>
                </select>
            </div>
            
            <div class="button-group">
                <button id="refresh-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                    Refresh Data
                </button>
                <button id="clear-filters" class="secondary">Clear Filters</button>
            </div>
        </div>
        
        <!-- Report Management Controls -->
        <div class="controls" style="border-top: 1px solid var(--border-light); padding-top: 15px; margin-top: 10px;">
            <div class="control-group">
                <label for="current-report">Current Monthly Report</label>
                <select id="current-report">
                    <option value="new">Create New Report</option>
                </select>
            </div>
            
            <div class="button-group">
                <button id="new-report-button" class="secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Report
                </button>
                <button id="load-report-button" class="secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <folder-open></folder-open>
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                    </svg>
                    Load Report
                </button>
                <button id="clear-checkmarks-button" class="secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                    </svg>
                    Clear All ✓
                </button>
            </div>
        </div>

        <div class="loader" id="loader"></div>
        
        <div class="metrics-panel">
            <div class="metrics-header">
                <h2 id="panel-title">Metric Analysis Dashboard</h2>
                <p id="panel-description">Showing significant metric changes and statistical anomalies</p>
            </div>
            <div class="metrics-table-container">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="metrics-table">
                    <thead>
                        <tr id="table-headers">
                            <th style="width: 40px; text-align: center;" title="Add to Monthly Report">+</th>
                            <th>Metric Name</th>
                            <th>District</th>
                            <th id="previous-header">Previous</th>
                            <th id="recent-header">Recent</th>
                            <th>Change</th>
                            <th>% Change</th>
                            <th>Analysis</th>
                        </tr>
                    </thead>
                        <tbody id="metrics-results">
                            <!-- Results will be populated here -->
                    </tbody>
                </table>
                </div>
                <div id="no-data" class="no-data" style="display: none;">No data available</div>
                <div id="error-container" class="error-message" style="display: none;">
                    <div id="error-text"></div>
                    <button id="retry-button" class="retry-button">Retry</button>
                </div>
            </div>
        </div>
        

        
        <!-- Remove the container-fluid structure -->
        <div id="results-container">
            <!-- Results will be displayed here -->
        </div>
    </div>
    
    <!-- Add Modal for Analysis -->
    <div id="analysis-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Analyzing Metric Change</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div id="modal-loader" class="loader"></div>
            <div id="modal-content">
                <iframe id="webchat-iframe" style="width: 100%; height: 600px; border: none; display: block;"></iframe>
            </div>
        </div>
    </div>
    
    <!-- Add Modal for Row Details -->
    <div id="row-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="row-modal-title">Metric Details</h3>
                <span class="row-modal-close">&times;</span>
            </div>
            <div id="row-modal-content">
                <div class="chart-container">
                    <div id="row-chart-loader" class="loader"></div>
                    <div id="row-chart-content"></div>
                </div>
                <div class="action-buttons">
                    <button id="add-to-monthly-report" class="action-button">
                        <i class="fas fa-file-alt"></i> Add to Monthly Report
                    </button>
                    <button id="generate-map" class="action-button">
                        <i class="fas fa-map"></i> Generate Map
                    </button>
                    <button id="analyze-metric" class="action-button">
                        <i class="fas fa-chart-line"></i> Analyze Metric
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Report Modal -->
    <div id="new-report-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Report</h3>
                <span class="close" onclick="closeNewReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <label for="report-name-input">Report Name:</label>
                <input type="text" id="report-name-input" placeholder="Enter report name..." style="width: 100%; padding: 8px; margin: 10px 0;">
                <div class="modal-actions">
                    <button onclick="confirmCreateNewReport()" class="action-btn primary-btn">Create Report</button>
                    <button onclick="closeNewReportModal()" class="action-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <script>
        // DOM elements
        const periodSelect = document.getElementById('period-select');
        const limitSelect = document.getElementById('limit-select');
        const objectIdInput = document.getElementById('object-id');
        const districtSelect = document.getElementById('district');
        const refreshButton = document.getElementById('refresh-button');
        const clearFiltersButton = document.getElementById('clear-filters');
        const loader = document.getElementById('loader');
        const metricsTable = document.getElementById('metrics-table');
        const metricsTbody = document.getElementById('metrics-results');
        const noDataDiv = document.getElementById('no-data');
        const errorContainer = document.getElementById('error-container');
        const errorText = document.getElementById('error-text');
        const retryButton = document.getElementById('retry-button');

        
        // Modal elements
        const analysisModal = document.getElementById('analysis-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalLoader = document.getElementById('modal-loader');
        const modalContent = document.getElementById('modal-content');
        const modalClose = document.querySelector('.modal-close');
        
        // Row details modal elements
        const rowDetailsModal = document.getElementById('row-details-modal');
        const rowModalTitle = document.getElementById('row-modal-title');
        const rowModalContent = document.getElementById('row-modal-content');
        const rowModalClose = document.querySelector('.row-modal-close');
        const rowChartLoader = document.getElementById('row-chart-loader');
        const rowChartContent = document.getElementById('row-chart-content');
        
        // Report management elements
        const currentReportSelect = document.getElementById('current-report');
        const newReportButton = document.getElementById('new-report-button');
        const loadReportButton = document.getElementById('load-report-button');
        const clearCheckmarksButton = document.getElementById('clear-checkmarks-button');
        
        // New report modal elements
        const newReportModal = document.getElementById('new-report-modal');
        const reportNameInput = document.getElementById('report-name-input');

        
        // Event listeners
        refreshButton.addEventListener('click', fetchAllData);
        periodSelect.addEventListener('change', function() {
            fetchAllData();
            // Also update headers if we have stored data
            if (lastMetricData) {
                updateTableHeaders();
            }
        });
        limitSelect.addEventListener('change', fetchAllData);
        
        // Store the last metric data to update headers when period changes
        let lastMetricData = null;
        districtSelect.addEventListener('change', fetchAllData);
        clearFiltersButton.addEventListener('click', clearFilters);
        retryButton.addEventListener('click', fetchAllData);
        
        // Report management event listeners
        newReportButton.addEventListener('click', createNewReport);
        loadReportButton.addEventListener('click', loadExistingReport);
        clearCheckmarksButton.addEventListener('click', clearAllCheckmarks);
        currentReportSelect.addEventListener('change', handleReportChange);
        
        // Close modal when clicking the X
        modalClose.addEventListener('click', function() {
            analysisModal.style.display = 'none';
        });
        
        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === analysisModal) {
                analysisModal.style.display = 'none';
            }
        });
        
        // Close row details modal when clicking the X
        rowModalClose.addEventListener('click', function() {
            rowDetailsModal.style.display = 'none';
        });
        
        // Close row details modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === rowDetailsModal) {
                rowDetailsModal.style.display = 'none';
            }
        });
        
        // Close new report modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === newReportModal) {
                newReportModal.style.display = 'none';
            }
        });
        

        
        // Clear filters function
        function clearFilters() {
            objectIdInput.value = '';
            districtSelect.value = '0'; // Reset to Citywide
            fetchAllData();
        }
        
        // Fetch data on page load
        document.addEventListener('DOMContentLoaded', fetchAllData);
        
        // Function to fetch all data (metric changes and anomalies)
        function fetchAllData() {
            // Show loader
            loader.style.display = 'block';
            metricsTbody.innerHTML = '';
            metricsTable.style.display = 'none';
            noDataDiv.style.display = 'none';
            errorContainer.style.display = 'none';
            
            // Get selected values
            const periodType = periodSelect.value;
            const limit = limitSelect.value;
            const objectId = objectIdInput.value.trim();
            const district = districtSelect.value;
            
            // Update header based on district
            const panelTitle = document.getElementById('panel-title');
            const panelDescription = document.getElementById('panel-description');
            
            if (district === '0') {
                panelTitle.textContent = 'Citywide Metric Analysis Dashboard';
            } else if (district === 'all') {
                panelTitle.textContent = 'All Districts Metric Analysis Dashboard';
            } else {
                panelTitle.textContent = `District ${district} Metric Analysis Dashboard`;
            }
            
            panelDescription.textContent = 'Showing significant metric changes and statistical anomalies';
            
            // Fetch both metric changes and anomalies
            Promise.all([
                fetchTopMetricChanges(periodType, limit, objectId, district),
                fetchAnomalies(periodType, limit, objectId, district)
            ]).then(([metricData, anomalyData]) => {
                // Hide loader
                loader.style.display = 'none';
                
                // Display combined results
                displayCombinedResults(metricData, anomalyData);
            }).catch(error => {
                // Handle errors
                loader.style.display = 'none';
                errorContainer.style.display = 'block';
                errorText.textContent = `Error: ${error.message}`;
                console.error('Error fetching data:', error);
            });
        }
        
        // Function to fetch top metric changes
        function fetchTopMetricChanges(periodType, limit, objectId, district) {
            // Build query parameters
            const params = new URLSearchParams({
                period_type: periodType,
                limit: limit,
                district: district
            });
            
            if (objectId && objectId.trim() !== '') {
                params.append('object_id', objectId.trim());
            }
            
            // Make API call and return promise
            return fetch(`/anomaly-analyzer/api/top-metric-changes?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch metric changes. Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        return {
                            positive_changes: data.positive_changes || [],
                            negative_changes: data.negative_changes || [],
                            stale_data_warnings: data.stale_data_warnings || 0,
                            periods: data.positive_changes && data.positive_changes.length > 0 ? 
                                data.positive_changes[0] : 
                                (data.negative_changes && data.negative_changes.length > 0 ? data.negative_changes[0] : null)
                        };
                    } else {
                        throw new Error(data.message || 'Error fetching metric changes');
                    }
                });
        }
        
        // Function to display combined results (metric changes and anomalies)
        function displayCombinedResults(metricData, anomalyData) {
            // Show the table
            metricsTable.style.display = 'table';
            metricsTbody.innerHTML = '';
            
            // Store metric data for header updates
            lastMetricData = metricData;
            
            // Update table headers with actual period values
            updateTableHeaders(metricData);
            
            // Display stale data warning summary if any
            if (metricData.stale_data_warnings && metricData.stale_data_warnings > 0) {
                const staleDataHeader = document.createElement('tr');
                staleDataHeader.className = 'stale-data-summary';
                staleDataHeader.innerHTML = `<td colspan="8">
                    <div class="stale-data-summary-content">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>⚠️ ${metricData.stale_data_warnings} metric${metricData.stale_data_warnings > 1 ? 's' : ''} with stale data detected. Hover over the warning icons for details.</span>
                    </div>
                </td>`;
                metricsTbody.appendChild(staleDataHeader);
            }
            
            // Check if we have any data at all
            const hasMetricData = (metricData.positive_changes && metricData.positive_changes.length > 0) || 
                                 (metricData.negative_changes && metricData.negative_changes.length > 0);
            const hasAnomalyData = (anomalyData.positive_anomalies && anomalyData.positive_anomalies.length > 0) || 
                                  (anomalyData.negative_anomalies && anomalyData.negative_anomalies.length > 0);
            
            if (!hasMetricData && !hasAnomalyData) {
                noDataDiv.style.display = 'block';
                noDataDiv.textContent = 'No data found matching your criteria. Try different filters.';
                return;
            }
            
            // Display Positive Changes section
            if (metricData.positive_changes && metricData.positive_changes.length > 0) {
                // Add section header for positive metric changes
                const positiveMetricHeader = document.createElement('tr');
                positiveMetricHeader.className = 'section-header';
                positiveMetricHeader.innerHTML = `<td colspan="8">📊 Positive Metric Changes</td>`;
                metricsTbody.appendChild(positiveMetricHeader);
                
                metricData.positive_changes.forEach(metric => appendMetricRow(metric));
            }
            
            // Display Positive Anomalies section
            if (anomalyData.positive_anomalies && anomalyData.positive_anomalies.length > 0) {
                // Add section header for positive anomalies
                const positiveAnomalyHeader = document.createElement('tr');
                positiveAnomalyHeader.className = 'section-header';
                positiveAnomalyHeader.innerHTML = `<td colspan="8">🚨 Positive Statistical Anomalies</td>`;
                metricsTbody.appendChild(positiveAnomalyHeader);
                
                anomalyData.positive_anomalies.forEach(anomaly => appendAnomalyRow(anomaly));
            }
            
            // Display Negative Changes section
            if (metricData.negative_changes && metricData.negative_changes.length > 0) {
                // Add section header for negative metric changes
                const negativeMetricHeader = document.createElement('tr');
                negativeMetricHeader.className = 'section-header';
                negativeMetricHeader.innerHTML = `<td colspan="8">📊 Negative Metric Changes</td>`;
                metricsTbody.appendChild(negativeMetricHeader);
                
                metricData.negative_changes.forEach(metric => appendMetricRow(metric));
            }
            
            // Display Negative Anomalies section
            if (anomalyData.negative_anomalies && anomalyData.negative_anomalies.length > 0) {
                // Add section header for negative anomalies
                const negativeAnomalyHeader = document.createElement('tr');
                negativeAnomalyHeader.className = 'section-header';
                negativeAnomalyHeader.innerHTML = `<td colspan="8">🚨 Negative Statistical Anomalies</td>`;
                metricsTbody.appendChild(negativeAnomalyHeader);
                
                anomalyData.negative_anomalies.forEach(anomaly => appendAnomalyRow(anomaly));
            }
        }
        
        // Function to fetch anomalies
        function fetchAnomalies(periodType, limit, objectId, district) {
            // Build API URL
            let apiUrl = `/anomaly-analyzer/api/query-anomalies?period_type=${periodType}&limit=${limit}&only_active=true&query_type=by_anomaly_severity`;
            
            if (objectId) {
                apiUrl += `&object_id=${encodeURIComponent(objectId)}`;
            }
            
            if (district && district !== 'all') {
                apiUrl += `&district=${encodeURIComponent(district)}`;
            }
            
            // Fetch data and return promise
            return fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Handle both old format (anomalies array) and new format (positive_anomalies, negative_anomalies)
                        if (data.positive_anomalies && data.negative_anomalies) {
                            // New format - combine positive and negative anomalies
                            return {
                                positive_anomalies: data.positive_anomalies || [],
                                negative_anomalies: data.negative_anomalies || []
                            };
                        } else {
                            // Old format - wrap in new structure for compatibility
                            return {
                                positive_anomalies: [],
                                negative_anomalies: data.anomalies || []
                            };
                        }
                    } else {
                        throw new Error(data.message || 'Error fetching anomalies');
                    }
                });
        }
        
        // Function to update table headers with actual period values
        function updateTableHeaders(metricData) {
            const previousHeader = document.getElementById('previous-header');
            const recentHeader = document.getElementById('recent-header');
            const periodType = periodSelect.value;
            
            // Default values
            let previousText = 'Previous';
            let recentText = 'Recent';
            
            // Use provided metricData or fall back to stored data
            const dataToUse = metricData || lastMetricData;
            
            // If we have period data from metrics, use it
            if (dataToUse && dataToUse.periods) {
                if (dataToUse.periods.previous_period) {
                    previousText = formatPeriodLabel(dataToUse.periods.previous_period, periodType);
                }
                if (dataToUse.periods.recent_period) {
                    recentText = formatPeriodLabel(dataToUse.periods.recent_period, periodType);
                }
            }
            
            previousHeader.textContent = previousText;
            recentHeader.textContent = recentText;
        }
        
        // Function to format period labels
        function formatPeriodLabel(periodValue, periodType) {
            if (!periodValue) return 'Previous';
            
            // Try to parse the period value
            let label = periodValue;
            
            // For different period types, format appropriately
            switch (periodType) {
                case 'day':
                    // Try to extract day info
                    if (periodValue.includes('D') || periodValue.includes('day')) {
                        label = periodValue;
                    } else {
                        // Try to format as date
                        try {
                            const date = new Date(periodValue);
                            if (!isNaN(date.getTime())) {
                                label = date.toLocaleDateString('en-US', { 
                                    weekday: 'short',
                                    month: 'short', 
                                    day: 'numeric', 
                                    year: 'numeric' 
                                });
                            }
                        } catch (e) {
                            label = periodValue;
                        }
                    }
                    break;
                    
                case 'week':
                    // Try to extract week number or date
                    if (periodValue.includes('W') || periodValue.includes('week')) {
                        label = periodValue;
                    } else {
                        // Try to format as date
                        try {
                            const date = new Date(periodValue);
                            if (!isNaN(date.getTime())) {
                                // Get the week number
                                const startOfYear = new Date(date.getFullYear(), 0, 1);
                                const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
                                const weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
                                label = `Week ${weekNumber}, ${date.getFullYear()}`;
                            }
                        } catch (e) {
                            label = periodValue;
                        }
                    }
                    break;
                    
                case 'month':
                    // Try to extract month name or number
                    if (periodValue.includes('M') || periodValue.includes('month')) {
                        label = periodValue;
                    } else {
                        // Try to format as date
                        try {
                            const date = new Date(periodValue);
                            if (!isNaN(date.getTime())) {
                                label = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                            }
                        } catch (e) {
                            label = periodValue;
                        }
                    }
                    break;
                    
                case 'year':
                    // Try to extract year
                    if (periodValue.includes('Y') || periodValue.includes('year')) {
                        label = periodValue;
                    } else {
                        // Try to format as date
                        try {
                            const date = new Date(periodValue);
                            if (!isNaN(date.getTime())) {
                                label = date.getFullYear().toString();
                            }
                        } catch (e) {
                            label = periodValue;
                        }
                    }
                    break;
                    
                default:
                    label = periodValue;
            }
            
            return label;
        }
        
        // Function to append a metric row
        function appendMetricRow(metric) {
            const row = document.createElement('tr');
            row.className = 'metric-row';
            row.setAttribute('data-metric', JSON.stringify(metric));
            
            // Determine the change class based on greendirection
            let changeClass = 'neutral-change'; // Default fallback
            const percentChange = parseFloat(metric.percent_change || 0);
            const greendirection = metric.greendirection;
            
            if (greendirection && percentChange !== 0) {
                if (greendirection.toLowerCase() === 'up') {
                    // For metrics where up is good
                    changeClass = percentChange > 0 ? 'positive-change' : 'negative-change';
                } else if (greendirection.toLowerCase() === 'down') {
                    // For metrics where down is good
                    changeClass = percentChange > 0 ? 'negative-change' : 'positive-change';
                } else {
                    // Fallback to traditional logic if greendirection is unexpected
                    changeClass = percentChange > 0 ? 'positive-change' : 'negative-change';
                }
            } else {
                // Fallback to traditional logic if no greendirection
                changeClass = percentChange > 0 ? 'positive-change' : 'negative-change';
            }
            
            // Format the district display
            const districtDisplay = metric.district === '0' ? 'Citywide' : `District ${metric.district}`;
            
            // Create a unique ID for this row to reference the metric data
            const rowId = 'metric-row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            row.id = rowId;
            
            // Add stale data warning indicator
            let staleDataIndicator = '';
            if (metric.stale_data_warning) {
                staleDataIndicator = `
                    <div class="stale-data-warning" title="${metric.stale_data_warning}">
                        <i class="fas fa-exclamation-triangle" title="${metric.stale_data_warning}"></i>
                        <span>Stale Data</span>
                    </div>
                `;
            }
            
            // Create item data for the button
            const itemData = {
                type: 'metric',
                id: metric.object_id,
                object_name: metric.object_name,
                group_name: metric.group_name,
                group_value: metric.group_value,
                district: metric.district,
                previous_value: metric.previous_value,
                recent_value: metric.recent_value,
                delta: metric.delta,
                percent_change: metric.percent_change,
                previous_period: metric.previous_period,
                recent_period: metric.recent_period,
                period_type: metric.period_type
            };
            
            // Check if item is already added
            const isAdded = isItemAddedToReport(itemData);
            const buttonClass = isAdded ? 'add-to-report-btn added' : 'add-to-report-btn';
            const buttonText = isAdded ? '✓' : '+';
            const buttonTitle = isAdded ? 'Click to remove from monthly report' : 'Add to Monthly Report';
            
            // Create row HTML
            row.innerHTML = `
                <td style="text-align: center; width: 60px;">
                    <button class="${buttonClass}" onclick="addToMonthlyReport(${JSON.stringify(itemData).replace(/"/g, '&quot;')})" title="${buttonTitle}">
                        ${buttonText}
                    </button>
                </td>
                <td>
                    ${metric.object_name}
                    ${staleDataIndicator}
                </td>
                <td>${districtDisplay}</td>
                <td>${formatValue(metric.previous_value)}</td>
                <td>${formatValue(metric.recent_value)}</td>
                <td class="${changeClass}">${formatValue(metric.delta)}</td>
                <td class="${changeClass}">${formatPercentChange(metric.percent_change)}</td>
                <td>
                    <button class="action-button" onclick="analyzeMetricFromRow('${rowId}')">
                        Analyze
                    </button>
                </td>
            `;
            
            // Add click event to show details modal
            row.addEventListener('click', function(e) {
                // Don't trigger if they clicked the analyze button
                if (e.target.tagName === 'BUTTON') return;
                
                // Remove selected class from all rows
                document.querySelectorAll('#metrics-results tr').forEach(r => {
                    r.classList.remove('selected');
                });
                
                // Add selected class to this row
                this.classList.add('selected');
                
                // Show metric details modal
                showMetricDetailsModal(metric).catch(error => {
                    console.error('Error showing metric details modal:', error);
                });
            });
            
            metricsTbody.appendChild(row);
        }
        
        // Helper function to analyze metric from row data
        function analyzeMetricFromRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                const metricDataStr = row.getAttribute('data-metric');
                if (metricDataStr) {
                    try {
                        const metric = JSON.parse(metricDataStr);
                        analyzeMetricChange(metric);
                    } catch (error) {
                        console.error('Error parsing metric data:', error);
                        alert('Error loading metric data. Please try again.');
                    }
                }
            }
        }
        
        // Function to append an anomaly row
        function appendAnomalyRow(anomaly) {
            const row = document.createElement('tr');
            row.className = 'anomaly-row';
            row.setAttribute('data-anomaly', JSON.stringify(anomaly));
            
            // Determine the change class based on greendirection (if available)
            let changeClass = 'neutral-change'; // Default fallback
            const percentChange = parseFloat(anomaly.percent_change || 0);
            const greendirection = anomaly.greendirection;
            
            if (greendirection && percentChange !== 0) {
                if (greendirection.toLowerCase() === 'up') {
                    // For metrics where up is good
                    changeClass = percentChange > 0 ? 'positive-change' : 'negative-change';
                } else if (greendirection.toLowerCase() === 'down') {
                    // For metrics where down is good
                    changeClass = percentChange > 0 ? 'negative-change' : 'positive-change';
                } else {
                    // Fallback to traditional logic if greendirection is unexpected
                    changeClass = percentChange > 0 ? 'positive-change' : 'negative-change';
                }
            } else {
                // Fallback to traditional logic if no greendirection
                changeClass = percentChange > 0 ? 'positive-change' : 'negative-change';
            }
            
            // Format the district display
            const districtDisplay = anomaly.district === '0' ? 'Citywide' : `District ${anomaly.district}`;
            
            // Create combined metric name with group information
            let metricName = anomaly.metric_name;
            if (anomaly.group_field_name && anomaly.group_value && anomaly.group_value !== 'N/A') {
                metricName = `${anomaly.metric_name} (${anomaly.group_field_name}: ${anomaly.group_value})`;
            } else if (anomaly.group_value && anomaly.group_value !== 'N/A') {
                metricName = `${anomaly.metric_name} (${anomaly.group_value})`;
            }
            
            // Create item data for the button
            const itemData = {
                type: 'anomaly',
                id: anomaly.id,
                object_name: anomaly.metric_name,
                group_name: anomaly.group_field_name,
                group_value: anomaly.group_value,
                district: anomaly.district,
                previous_value: anomaly.comparison_mean,
                recent_value: anomaly.recent_mean,
                delta: anomaly.difference || (anomaly.recent_mean - anomaly.comparison_mean),
                percent_change: anomaly.percent_change,
                previous_period: anomaly.period_date,
                recent_period: anomaly.period_date,
                period_type: anomaly.period_type,
                anomaly_id: anomaly.id
            };
            
            // Check if item is already added
            const isAdded = isItemAddedToReport(itemData);
            const buttonClass = isAdded ? 'add-to-report-btn added' : 'add-to-report-btn';
            const buttonText = isAdded ? '✓' : '+';
            const buttonTitle = isAdded ? 'Click to remove from monthly report' : 'Add to Monthly Report';
            
            // Create row HTML
            row.innerHTML = `
                <td style="text-align: center; width: 60px;">
                    <button class="${buttonClass}" onclick="addToMonthlyReport(${JSON.stringify(itemData).replace(/"/g, '&quot;')})" title="${buttonTitle}">
                        ${buttonText}
                    </button>
                </td>
                <td>${metricName}</td>
                <td>${districtDisplay}</td>
                <td>${formatValue(anomaly.comparison_mean)}</td>
                <td>${formatValue(anomaly.recent_mean)}</td>
                <td class="${changeClass}">${formatValue(anomaly.difference || (anomaly.recent_mean - anomaly.comparison_mean))}</td>
                <td class="${changeClass}">${formatPercentChange(anomaly.percent_change)}</td>
                <td>
                    <button class="action-button" onclick="analyzeMetricChange(${JSON.stringify({
                        id: anomaly.metric_key,
                        object_name: anomaly.metric_name,
                        group_name: anomaly.group_field_name,
                        group_value: anomaly.group_value,
                        anomaly_id: anomaly.id,
                        district: anomaly.district,
                        previous_value: anomaly.comparison_mean,
                        recent_value: anomaly.recent_mean,
                        delta: anomaly.difference,
                        percent_change: anomaly.percent_change,
                        previous_period: anomaly.period_date,
                        recent_period: anomaly.period_date,
                        period_type: anomaly.period_type
                    }).replace(/"/g, '&quot;')})">
                        Analyze
                    </button>
                </td>
            `;
            
            // Add click event to show details modal
            row.addEventListener('click', function(e) {
                // Don't trigger if they clicked the analyze button
                if (e.target.tagName === 'BUTTON') return;
                
                // Remove selected class from all rows
                document.querySelectorAll('#metrics-results tr').forEach(r => {
                    r.classList.remove('selected');
                });
                
                // Add selected class to this row
                this.classList.add('selected');
                
                // Show anomaly details modal
                showAnomalyDetailsModal(anomaly);
            });
            
            metricsTbody.appendChild(row);
        }
        
        // Helper function to format values
        function formatValue(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return parseFloat(value).toLocaleString(undefined, {maximumFractionDigits: 2});
        }
        
        // Helper function to format percent changes
        function formatPercentChange(value) {
            if (value === null || value === undefined || isNaN(value)) return '-';
            return `${parseFloat(value).toFixed(2)}%`;
        }
        
        // Function to show metric details modal
        async function showMetricDetailsModal(metric) {
            console.log('showMetricDetailsModal called with:', metric);
            // Show the modal
            rowDetailsModal.style.display = 'block';
            rowModalTitle.textContent = `${metric.object_name || 'Metric'} Details`;
            
            // Show loader
            rowChartLoader.style.display = 'block';
            rowChartContent.innerHTML = '';
            
            // Get chart data
            const metricId = metric.object_id || metric.id;
            const district = metric.district || '0';
            const periodType = periodSelect.value;
            
            // Create container for charts and maps
            const contentContainer = document.createElement('div');
            contentContainer.style.display = 'flex';
            contentContainer.style.flexDirection = 'column';
            contentContainer.style.gap = '20px';
            
            // Create chart iframe
            const chartIframe = document.createElement('iframe');
            chartIframe.style.width = '100%';
            chartIframe.style.height = '600px';
            chartIframe.style.border = 'none';
            chartIframe.style.display = 'block';
            chartIframe.style.borderRadius = '8px';
            
            // Set chart URL based on period type
            let chartUrl;
            if (periodType === 'month') {
                chartUrl = `/backend/time-series-chart?metric_id=${metricId}&district=${district}&period_type=month`;
            } else if (periodType === 'year') {
                chartUrl = `/backend/time-series-chart?metric_id=${metricId}&district=${district}&period_type=year`;
            } else if (periodType === 'week') {
                chartUrl = `/backend/time-series-chart?metric_id=${metricId}&district=${district}&period_type=week`;
            } else {
                chartUrl = `/backend/time-series-chart?metric_id=${metricId}&district=${district}&period_type=day`;
            }
            
            console.log('Setting chart iframe src to:', chartUrl);
            chartIframe.src = chartUrl;
            
                        // Always append the chart iframe first
            contentContainer.appendChild(chartIframe);
            
            // Create map iframes (for all districts, not just citywide)
            try {
                let mapsResponse;
                try {
                    mapsResponse = await fetch(`/api/all-maps?metric_id=${metricId}`);
                    if (!mapsResponse.ok) {
                        throw new Error(`Failed to fetch from main API: ${mapsResponse.status}`);
                    }
                } catch (apiError) {
                    console.warn('Error using main API endpoint, falling back to backend:', apiError);
                    mapsResponse = await fetch(`/backend/api/all-maps?metric_id=${metricId}`);
                    if (!mapsResponse.ok) {
                        throw new Error(`Failed to fetch maps: ${mapsResponse.status}`);
                    }
                }
                
                const mapsData = await mapsResponse.json();
                console.log('Maps data received:', mapsData);
                if (mapsData.status === 'success' && mapsData.maps && mapsData.maps.length > 0) {
                    console.log(`Found ${mapsData.maps.length} maps for metric:`, metricId);
                    
                    // Create a maps section header
                    const mapsHeader = document.createElement('h3');
                    mapsHeader.textContent = '🗺️ Generated Maps';
                    mapsHeader.style.marginTop = '20px';
                    mapsHeader.style.marginBottom = '15px';
                    mapsHeader.style.color = 'var(--text-primary)';
                    mapsHeader.style.fontSize = '18px';
                    mapsHeader.style.fontWeight = '600';
                    mapsHeader.style.borderBottom = '2px solid var(--border-primary)';
                    mapsHeader.style.paddingBottom = '8px';
                    contentContainer.appendChild(mapsHeader);
                    
                    // Create iframes for all available maps
                    mapsData.maps.forEach((map, index) => {
                        console.log(`Creating iframe for map ${index + 1}:`, map);
                        
                        // Create map container
                        const mapContainer = document.createElement('div');
                        mapContainer.style.marginBottom = '20px';
                        mapContainer.style.border = '1px solid var(--border-primary)';
                        mapContainer.style.borderRadius = '8px';
                        mapContainer.style.overflow = 'hidden';
                        
                        // Add a title/label for each map
                        const mapLabel = document.createElement('h4');
                        mapLabel.textContent = map.title || `Map ${index + 1}`;
                        mapLabel.style.margin = '0';
                        mapLabel.style.padding = '12px 16px';
                        mapLabel.style.backgroundColor = 'var(--bg-secondary)';
                        mapLabel.style.color = 'var(--text-primary)';
                        mapLabel.style.fontSize = '14px';
                        mapLabel.style.fontWeight = '600';
                        mapLabel.style.borderBottom = '1px solid var(--border-primary)';
                        
                        const mapIframe = document.createElement('iframe');
                        mapIframe.style.width = '100%';
                        mapIframe.style.height = '500px';
                        mapIframe.style.border = 'none';
                        mapIframe.style.display = 'block';
                        
                        // Use the published_url directly instead of the backend endpoint
                        if (map.published_url) {
                            console.log(`Setting map ${index + 1} iframe src to:`, map.published_url);
                            mapIframe.src = map.published_url;
                        } else {
                            console.warn(`No published_url found for map ${index + 1}, trying backend endpoint`);
                            const mapUrl = `/backend/map-chart?id=${map.id}`;
                            mapIframe.src = mapUrl;
                        }
                        
                        // Add label and iframe to container
                        mapContainer.appendChild(mapLabel);
                        mapContainer.appendChild(mapIframe);
                        contentContainer.appendChild(mapContainer);
                    });
                } else {
                    console.log('No maps found for metric:', metricId);
                    
                    // Add a "no maps" message
                    const noMapsMessage = document.createElement('div');
                    noMapsMessage.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <i class="fas fa-map" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            <p>No maps have been generated for this metric yet.</p>
                            <p>Click "Generate Map" below to create a new map.</p>
                        </div>
                    `;
                    contentContainer.appendChild(noMapsMessage);
                }
            } catch (error) {
                console.warn('Failed to fetch maps for metric:', error);
                
                // Add error message
                const errorMessage = document.createElement('div');
                errorMessage.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--error);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        <p>Failed to load maps for this metric.</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
                contentContainer.appendChild(errorMessage);
            }
            
            rowChartContent.appendChild(contentContainer);

            // Hide loader when chart loads
            chartIframe.onload = function() {
                console.log('Chart iframe loaded successfully');
                rowChartLoader.style.display = 'none';
            };
            
            // Handle iframe load errors
            chartIframe.onerror = function() {
                console.error('Chart iframe failed to load');
                rowChartLoader.style.display = 'none';
                rowChartContent.innerHTML = '<div class="error-message">Failed to load chart. Please try again.</div>';
            };
            
            // Add timeout to handle cases where iframe doesn't load
            setTimeout(() => {
                if (rowChartLoader.style.display !== 'none') {
                    console.warn('Chart iframe load timeout');
                    rowChartLoader.style.display = 'none';
                    rowChartContent.innerHTML = '<div class="error-message">Chart is taking longer than expected to load. Please try again.</div>';
                }
            }, 10000); // 10 second timeout
            
            // Set up action button event listeners
            setupActionButtons(metric, 'metric');
        }
        
        // Function to show anomaly details modal
        async function showAnomalyDetailsModal(anomaly) {
            console.log('showAnomalyDetailsModal called with:', anomaly);
            // Show the modal
            rowDetailsModal.style.display = 'block';
            rowModalTitle.textContent = `${anomaly.metric_name || 'Anomaly'} Details`;
            
            // Show loader
            rowChartLoader.style.display = 'block';
            rowChartContent.innerHTML = '';
            
            // Get anomaly chart
            const anomalyId = anomaly.id;
            const metricId = anomaly.metric_key || anomaly.object_id;
            
            // Create container for charts and maps
            const contentContainer = document.createElement('div');
            contentContainer.style.display = 'flex';
            contentContainer.style.flexDirection = 'column';
            contentContainer.style.gap = '20px';
            
            // Create chart iframe
            const chartIframe = document.createElement('iframe');
            chartIframe.style.width = '100%';
            chartIframe.style.height = '600px';
            chartIframe.style.border = 'none';
            chartIframe.style.display = 'block';
            chartIframe.style.borderRadius = '8px';
            
            // Set chart URL
            const chartUrl = `/anomaly-analyzer/anomaly-chart?id=${anomalyId}`;
            console.log('Setting anomaly chart iframe src to:', chartUrl);
            chartIframe.src = chartUrl;
            
            // Always append the chart iframe first
            contentContainer.appendChild(chartIframe);
            
            // Create map iframes for the anomaly's metric
            if (metricId) {
                try {
                    let mapsResponse;
                    try {
                        mapsResponse = await fetch(`/api/all-maps?metric_id=${metricId}`);
                        if (!mapsResponse.ok) {
                            throw new Error(`Failed to fetch from main API: ${mapsResponse.status}`);
                        }
                    } catch (apiError) {
                        console.warn('Error using main API endpoint, falling back to backend:', apiError);
                        mapsResponse = await fetch(`/backend/api/all-maps?metric_id=${metricId}`);
                        if (!mapsResponse.ok) {
                            throw new Error(`Failed to fetch maps: ${mapsResponse.status}`);
                        }
                    }
                    
                    const mapsData = await mapsResponse.json();
                    console.log('Maps data received for anomaly:', mapsData);
                    if (mapsData.status === 'success' && mapsData.maps && mapsData.maps.length > 0) {
                        console.log(`Found ${mapsData.maps.length} maps for anomaly metric:`, metricId);
                        
                        // Create a maps section header
                        const mapsHeader = document.createElement('h3');
                        mapsHeader.textContent = '🗺️ Generated Maps';
                        mapsHeader.style.marginTop = '20px';
                        mapsHeader.style.marginBottom = '15px';
                        mapsHeader.style.color = 'var(--text-primary)';
                        mapsHeader.style.fontSize = '18px';
                        mapsHeader.style.fontWeight = '600';
                        mapsHeader.style.borderBottom = '2px solid var(--border-primary)';
                        mapsHeader.style.paddingBottom = '8px';
                        contentContainer.appendChild(mapsHeader);
                        
                        // Create iframes for all available maps
                        mapsData.maps.forEach((map, index) => {
                            console.log(`Creating iframe for map ${index + 1}:`, map);
                            
                            // Create map container
                            const mapContainer = document.createElement('div');
                            mapContainer.style.marginBottom = '20px';
                            mapContainer.style.border = '1px solid var(--border-primary)';
                            mapContainer.style.borderRadius = '8px';
                            mapContainer.style.overflow = 'hidden';
                            
                            // Add a title/label for each map
                            const mapLabel = document.createElement('h4');
                            mapLabel.textContent = map.title || `Map ${index + 1}`;
                            mapLabel.style.margin = '0';
                            mapLabel.style.padding = '12px 16px';
                            mapLabel.style.backgroundColor = 'var(--bg-secondary)';
                            mapLabel.style.color = 'var(--text-primary)';
                            mapLabel.style.fontSize = '14px';
                            mapLabel.style.fontWeight = '600';
                            mapLabel.style.borderBottom = '1px solid var(--border-primary)';
                            
                            const mapIframe = document.createElement('iframe');
                            mapIframe.style.width = '100%';
                            mapIframe.style.height = '500px';
                            mapIframe.style.border = 'none';
                            mapIframe.style.display = 'block';
                            
                            // Use the published_url directly instead of the backend endpoint
                            if (map.published_url) {
                                console.log(`Setting map ${index + 1} iframe src to:`, map.published_url);
                                mapIframe.src = map.published_url;
                            } else {
                                console.warn(`No published_url found for map ${index + 1}, trying backend endpoint`);
                                const mapUrl = `/backend/map-chart?id=${map.id}`;
                                mapIframe.src = mapUrl;
                            }
                            
                            // Add label and iframe to container
                            mapContainer.appendChild(mapLabel);
                            mapContainer.appendChild(mapIframe);
                            contentContainer.appendChild(mapContainer);
                        });
                    } else {
                        console.log('No maps found for anomaly metric:', metricId);
                        
                        // Add a "no maps" message
                        const noMapsMessage = document.createElement('div');
                        noMapsMessage.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                <i class="fas fa-map" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                <p>No maps have been generated for this metric yet.</p>
                                <p>Click "Generate Map" below to create a new map.</p>
                            </div>
                        `;
                        contentContainer.appendChild(noMapsMessage);
                    }
                } catch (error) {
                    console.warn('Failed to fetch maps for anomaly metric:', error);
                    
                    // Add error message
                    const errorMessage = document.createElement('div');
                    errorMessage.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--error);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            <p>Failed to load maps for this metric.</p>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
                    contentContainer.appendChild(errorMessage);
                }
            }
            
            rowChartContent.appendChild(contentContainer);

            // Hide loader when chart loads
            chartIframe.onload = function() {
                console.log('Anomaly chart iframe loaded successfully');
                rowChartLoader.style.display = 'none';
            };
            
            // Handle iframe load errors
            chartIframe.onerror = function() {
                console.error('Anomaly chart iframe failed to load');
                rowChartLoader.style.display = 'none';
                rowChartContent.innerHTML = '<div class="error-message">Failed to load anomaly chart. Please try again.</div>';
            };
            
            // Add timeout to handle cases where iframe doesn't load
            setTimeout(() => {
                if (rowChartLoader.style.display !== 'none') {
                    console.warn('Anomaly chart iframe load timeout');
                    rowChartLoader.style.display = 'none';
                    rowChartContent.innerHTML = '<div class="error-message">Anomaly chart is taking longer than expected to load. Please try again.</div>';
                }
            }, 10000); // 10 second timeout
            
            // Set up action button event listeners
            setupActionButtons(anomaly, 'anomaly');
        }
        
        // Function to set up action buttons
        function setupActionButtons(data, type) {
            // Remove existing event listeners
            const addToReportBtn = document.getElementById('add-to-monthly-report');
            const generateMapBtn = document.getElementById('generate-map');
            const analyzeBtn = document.getElementById('analyze-metric');
            
            // Clone buttons to remove old event listeners
            const newAddToReportBtn = addToReportBtn.cloneNode(true);
            const newGenerateMapBtn = generateMapBtn.cloneNode(true);
            const newAnalyzeBtn = analyzeBtn.cloneNode(true);
            
            addToReportBtn.parentNode.replaceChild(newAddToReportBtn, addToReportBtn);
            generateMapBtn.parentNode.replaceChild(newGenerateMapBtn, generateMapBtn);
            analyzeBtn.parentNode.replaceChild(newAnalyzeBtn, analyzeBtn);
            
            // Add to monthly report
            newAddToReportBtn.addEventListener('click', function() {
                console.log('Add to monthly report clicked for:', data);
                // TODO: Implement add to monthly report functionality
                alert('Add to monthly report functionality will be implemented soon.');
            });
            
            // Generate map
            newGenerateMapBtn.addEventListener('click', function() {
                console.log('Generate map clicked for:', data);
                
                // Show loading state
                const originalText = newGenerateMapBtn.innerHTML;
                newGenerateMapBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Map...';
                newGenerateMapBtn.disabled = true;
                
                // Prepare the request data
                const requestData = {
                    metric_id: data.id || data.object_id,
                    district: data.district || '0',
                    period_type: periodSelect.value || 'month'
                };
                
                // Add anomaly_id if this is an anomaly
                if (data.anomaly_id) {
                    requestData.anomaly_id = data.anomaly_id;
                }
                
                console.log('Sending generate map request:', requestData);
                
                // Make API call to generate map
                fetch('/anomaly-analyzer/api/generate-map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(result => {
                    console.log('Generate map response:', result);
                    
                    if (result.status === 'success') {
                        // Show success message with map details
                        const mapType = result.map_type === 'locator' ? 'Locator Map' : 'Symbol Chart';
                        const message = `Successfully generated ${mapType} with ${result.data_points} data points!\n\n` +
                                      `Map ID: ${result.map_id}\n` +
                                      `View Map: ${result.publish_url}\n` +
                                      `Edit Map: ${result.edit_url}`;
                        
                        alert(message);
                        
                        // Optionally open the map in a new tab
                        if (result.publish_url) {
                            const openMap = confirm('Would you like to open the map in a new tab?');
                            if (openMap) {
                                window.open(result.publish_url, '_blank');
                            }
                        }
                    } else {
                        // Show error message
                        alert(`Error generating map: ${result.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error generating map:', error);
                    alert(`Error generating map: ${error.message}`);
                })
                .finally(() => {
                    // Reset button state
                    newGenerateMapBtn.innerHTML = originalText;
                    newGenerateMapBtn.disabled = false;
                });
            });
            
            // Analyze metric
            newAnalyzeBtn.addEventListener('click', function() {
                console.log('Analyze metric clicked for:', data);
                if (type === 'metric') {
                    analyzeMetricChange(data);
                } else {
                    // For anomalies, create a metric-like object
                    const metricData = {
                        id: data.object_id,
                        object_name: data.metric_name,
                        district: data.district,
                        previous_value: data.comparison_mean,
                        recent_value: data.recent_mean,
                        delta: data.difference,
                        percent_change: data.percent_change,
                        previous_period: data.period_date,
                        recent_period: data.period_date,
                        period_type: data.period_type
                    };
                    analyzeMetricChange(metricData);
                }
                // Close the details modal
                rowDetailsModal.style.display = 'none';
            });
        }
        
        // Function to analyze a metric change
        function analyzeMetricChange(metric) {
            // Check if we're running inside an iframe (i.e., in backend.html)
            if (window.parent && window.parent !== window) {
                // We're in an iframe, communicate with parent to open Seymour
                const message = {
                    type: 'ANALYZE_METRIC_CHANGE',
                    metric: metric
                };
                window.parent.postMessage(message, '*');
                return;
            }
            
            // Original logic for standalone mode
            // Check URL parameters to see if we're in embed mode
            const urlParams = new URLSearchParams(window.location.search);
            const embedMode = urlParams.get('embed_mode') === 'true';
            
            // Debug logging to see what fields are available
            console.log('Metric object received:', metric);
            console.log('Available metric fields:', Object.keys(metric));
            
            // Format and prepare metric data
            // The metric ID should be in object_id from the API response
            const metricId = metric.object_id || metric.id || '';
            console.log('Extracted metric ID:', metricId);
            
            const metricData = {
                id: metricId,
                name: metric.object_name || '',
                district: metric.district || '0',
                previousValue: formatValue(metric.previous_value),
                recentValue: formatValue(metric.recent_value),
                delta: formatValue(metric.delta),
                percentChange: metric.percent_change ? parseFloat(metric.percent_change).toFixed(2) : '0',
                previousPeriod: metric.previous_period || '',
                recentPeriod: metric.recent_period || '',
                direction: parseFloat(metric.delta || 0) > 0 ? 'increased' : 'decreased',
                magnitude: Math.abs(parseFloat(metric.percent_change || 0)) > 50 ? 'significant' : 
                          Math.abs(parseFloat(metric.percent_change || 0)) > 20 ? 'moderate' : 'minor'
            };

            // Format the district display
            const districtDisplay = metricData.district === '0' ? 'citywide' : `District ${metricData.district}`;
            
            // Create the prompt message based on whether this is an anomaly or regular metric
            let promptMessage;
            if (metric.anomaly_id) {
                // This is an anomaly analysis
                promptMessage = `The metric "${metricData.name}" (ID: ${metricData.id}) for ${districtDisplay} in ${metric.group_name} "${metric.group_value}" has ${metricData.direction} from ${metricData.previousValue} in ${metricData.previousPeriod} to ${metricData.recentValue} in ${metricData.recentPeriod}, an absolute change of ${metricData.delta} and a percentage change of ${metricData.percentChange}%.

Can you help me understand:
1. What might have caused this change?
2. Is this part of a broader trend?`;
            } else {
                // This is a regular metric analysis
                promptMessage = `The metric "${metricData.name}" (ID: ${metricData.id}) for ${districtDisplay} has ${metricData.direction} from ${metricData.previousValue} in ${metricData.previousPeriod} to ${metricData.recentValue} in ${metricData.recentPeriod}, an absolute change of ${metricData.delta} and a percentage change of ${metricData.percentChange}%.

Can you help me understand:
1. What might have caused this change?
2. Is this part of a broader trend?`;
            }
            
            // Log the final prompt for debugging
            console.log('Generated prompt:', promptMessage);
            
            // Check if we have a valid metric ID
            if (!metricData.id || metricData.id.trim() === '') {
                console.warn('No valid metric ID found. Available fields:', Object.keys(metric));
                // We can still proceed with analysis using the metric name
                console.log('Proceeding with analysis using metric name instead of ID');
            }
            
            if (embedMode) {
                // In embed mode, we'll skip the modal and display the webchat directly
                const analysisContainer = document.getElementById('metrics-results');
                if (analysisContainer) {
                    // Clear existing content
                    analysisContainer.innerHTML = '';
                    
                    // Create a container for the webchat
                    const webchatContainer = document.createElement('div');
                    webchatContainer.style.width = '100%';
                    webchatContainer.style.height = '600px';
                    webchatContainer.style.border = '1px solid var(--neutral-gray-light)';
                    webchatContainer.style.borderRadius = '8px';
                    webchatContainer.style.overflow = 'hidden';
                    webchatContainer.style.marginTop = '20px';
                    
                    // Create and append the webchat iframe
                    const webchatIframe = document.createElement('iframe');
                    webchatIframe.style.width = '100%';
                    webchatIframe.style.height = '100%';
                    webchatIframe.style.border = 'none';
                    webchatIframe.style.display = 'block';
                    
                    // Build query parameters with structured data
                    const params = new URLSearchParams({
                        initialize: 'true',
                        analyze: 'true',
                        metric_id: metricData.id || '',
                        metric_name: metricData.name,
                        district: metricData.district,
                        previous_value: metricData.previousValue,
                        recent_value: metricData.recentValue,
                        delta: metricData.delta,
                        previous_period: metricData.previousPeriod,
                        recent_period: metricData.recentPeriod,
                        direction: metricData.direction,
                        percent_change: metricData.percentChange,
                        magnitude: metricData.magnitude,
                        prompt: promptMessage
                    });

                    // Add anomaly-specific parameters if this is an anomaly
                    if (metric.anomaly_id) {
                        params.append('anomaly_id', metric.anomaly_id);
                        params.append('group_name', metric.group_name);
                        params.append('group_value', metric.group_value);
                    }
                    
                    // Log the parameters being sent
                    console.log('WebChat parameters:', params.toString());
                    
                    // Set chat initialization parameters
                    webchatIframe.src = `/webchat?${params.toString()}`;
                    
                    // Append iframe to container
                    webchatContainer.appendChild(webchatIframe);
                    analysisContainer.appendChild(webchatContainer);
                    
                    // Hide other UI elements
                    const metricsTable = document.getElementById('metrics-table');
                    if (metricsTable) {
                        metricsTable.style.display = 'none';
                    }
                    
                    // Add a back button
                    const backButton = document.createElement('button');
                    backButton.className = 'action-button';
                    backButton.style.marginTop = '10px';
                    backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Back to metrics';
                    backButton.onclick = function() {
                        // Show the metrics table again
                        if (metricsTable) {
                            metricsTable.style.display = 'table';
                        }
                        // Remove the webchat container
                        webchatContainer.remove();
                        backButton.remove();
                    };
                    
                    analysisContainer.appendChild(backButton);
                }
                return;
            }
            
            // Standard modal view for non-embed mode
            // Show the modal
            analysisModal.style.display = 'block';
            modalTitle.textContent = `Analyzing ${metricData.name || 'Metric Change'}`;
            modalLoader.style.display = 'block';
            
            // Set up webchat iframe
            const webchatIframe = document.createElement('iframe');
            webchatIframe.id = 'webchat-iframe';
            webchatIframe.style.display = 'block';
            modalContent.innerHTML = '';
            modalContent.appendChild(webchatIframe);
            
            // Build query parameters with structured data
            const params = new URLSearchParams({
                initialize: 'true',
                analyze: 'true',
                metric_id: metricData.id || '',
                metric_name: metricData.name,
                district: metricData.district,
                previous_value: metricData.previousValue,
                recent_value: metricData.recentValue,
                delta: metricData.delta,
                previous_period: metricData.previousPeriod,
                recent_period: metricData.recentPeriod,
                direction: metricData.direction,
                percent_change: metricData.percentChange,
                magnitude: metricData.magnitude,
                prompt: promptMessage
            });

            // Add anomaly-specific parameters if this is an anomaly
            if (metric.anomaly_id) {
                params.append('anomaly_id', metric.anomaly_id);
                params.append('group_name', metric.group_name);
                params.append('group_value', metric.group_value);
            }
            
            // Log the parameters being sent
            console.log('WebChat parameters:', params.toString());
            
            // Set chat initialization parameters
            webchatIframe.src = `/webchat?${params.toString()}`;
            
            // On iframe load
            webchatIframe.onload = function() {
                modalLoader.style.display = 'none';
                webchatIframe.style.display = 'block';
                
                // Ensure the iframe takes up the full available space
                webchatIframe.style.width = '100%';
                webchatIframe.style.height = '600px';
                
                // Add a small delay to ensure the iframe is fully rendered
                setTimeout(() => {
                    webchatIframe.focus();
                }, 100);
            };
            
            // Handle iframe load errors
            webchatIframe.onerror = function() {
                modalLoader.style.display = 'none';
                modalContent.innerHTML = '<div class="error-message">Failed to load analysis. Please try again.</div>';
            };
            
            // Add a timeout to handle server errors
            setTimeout(() => {
                if (modalLoader.style.display !== 'none') {
                    modalLoader.style.display = 'none';
                    modalContent.innerHTML = '<div class="error-message">Analysis is taking longer than expected. The server might be busy. Please try again later.</div>';
                }
            }, 10000); // 10 second timeout
        }
        
        // Function to add/remove items from monthly report
        async function addToMonthlyReport(itemData) {
            console.log('addToMonthlyReport called with:', itemData);
            
            // Get the button that was clicked
            const button = event.target;
            
            // Check if item is already added
            const isAlreadyAdded = isItemAddedToReport(itemData);
            
            if (isAlreadyAdded) {
                // Remove from monthly report (no confirmation)
                try {
                    // Disable button during request
                    button.disabled = true;
                    button.innerHTML = '...';
                    
                    // Call API to remove from database
                    const response = await fetch('/anomaly-analyzer/api/remove-from-monthly-report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            item_data: itemData
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Remove from localStorage
                        const addedItems = JSON.parse(localStorage.getItem('addedToMonthlyReport') || '[]');
                        const itemKey = generateItemKey(itemData);
                        const updatedItems = addedItems.filter(key => key !== itemKey);
                        localStorage.setItem('addedToMonthlyReport', JSON.stringify(updatedItems));
                        
                        // Update button state
                        button.innerHTML = '+';
                        button.classList.remove('added');
                        button.title = 'Add to Monthly Report';
                    } else if (result.message && result.message.includes('not found')) {
                        // Item not found in database, just remove from localStorage and reset button
                        const addedItems = JSON.parse(localStorage.getItem('addedToMonthlyReport') || '[]');
                        const itemKey = generateItemKey(itemData);
                        const updatedItems = addedItems.filter(key => key !== itemKey);
                        localStorage.setItem('addedToMonthlyReport', JSON.stringify(updatedItems));
                        
                        // Update button state
                        button.innerHTML = '+';
                        button.classList.remove('added');
                        button.title = 'Add to Monthly Report';
                    } else {
                        throw new Error(result.message || 'Failed to remove item from monthly report');
                    }
                } catch (error) {
                    console.error('Error removing item from monthly report:', error);
                    
                    // Reset button state
                    button.innerHTML = '✓';
                    button.disabled = false;
                }
                return;
            }
            
            // Add to monthly report
            try {
                // Disable button during request
                button.disabled = true;
                button.innerHTML = '...';
                
                // Use default report title
                const reportTitle = 'Monthly Manual Report';
                
                // Prepare the data for the API
                const requestData = {
                    item_data: itemData,
                    report_title: reportTitle,
                    period_type: itemData.period_type || 'month'
                };
                
                console.log('Sending request data:', requestData);
                
                // Make API call to add item to monthly report
                const response = await fetch('/anomaly-analyzer/api/add-to-monthly-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);
                
                if (result.status === 'success') {
                    // Mark the button as added
                    if (button) {
                        button.innerHTML = '✓';
                        button.classList.add('added');
                        button.disabled = false; // Allow toggling
                        button.title = 'Click to remove from monthly report';
                        
                        // Store the added item in localStorage for persistence
                        const addedItems = JSON.parse(localStorage.getItem('addedToMonthlyReport') || '[]');
                        const itemKey = generateItemKey(itemData);
                        if (!addedItems.includes(itemKey)) {
                            addedItems.push(itemKey);
                            localStorage.setItem('addedToMonthlyReport', JSON.stringify(addedItems));
                        }
                        
                        // Store the current date
                        localStorage.setItem('lastAddedDate', new Date().toDateString());
                    }
                } else {
                    throw new Error(result.message || 'Failed to add item to monthly report');
                }
                
            } catch (error) {
                console.error('Error adding item to monthly report:', error);
                alert(`Error: ${error.message}`);
                
                // Reset button state
                if (button) {
                    button.innerHTML = '+';
                    button.disabled = false;
                }
            }
        }
        
        // Function to generate a unique key for an item
        function generateItemKey(itemData) {
            // For anomalies, use anomaly_id, for metrics use metric_id and district
            if (itemData.type === 'anomaly' && itemData.anomaly_id) {
                return `anomaly_${itemData.anomaly_id}`;
            } else {
                return `metric_${itemData.id}_${itemData.district}`;
            }
        }
        
        // Function to check if an item has been added to monthly report
        function isItemAddedToReport(itemData) {
            const addedItems = JSON.parse(localStorage.getItem('addedToMonthlyReport') || '[]');
            const itemKey = generateItemKey(itemData);
            return addedItems.includes(itemKey);
        }
        
        // Function to mark button as added (for items already in reports)
        function markButtonAsAdded(button, itemData) {
            if (isItemAddedToReport(itemData)) {
                button.innerHTML = '✓';
                button.classList.add('added');
                button.disabled = false; // Allow toggling
                button.title = 'Click to remove from monthly report';
            }
        }
        
        // Function to clear added items (useful for new month or reset)
        function clearAddedItems() {
            localStorage.removeItem('addedToMonthlyReport');
            // Refresh the page to update all buttons
            location.reload();
        }
        
        // Function to check if we should clear added items (e.g., new month)
        function checkAndClearAddedItems() {
            const addedItems = JSON.parse(localStorage.getItem('addedToMonthlyReport') || '[]');
            if (addedItems.length > 0) {
                const lastAddedDate = localStorage.getItem('lastAddedDate');
                const currentDate = new Date().toDateString();
                
                if (lastAddedDate !== currentDate) {
                    // Check if it's a new month
                    const lastDate = new Date(lastAddedDate || 0);
                    const currentMonth = new Date().getMonth();
                    const lastMonth = lastDate.getMonth();
                    
                    if (currentMonth !== lastMonth) {
                        // New month, clear the added items
                        clearAddedItems();
                        return;
                    }
                }
            }
        }
        
        // Check for new month on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAndClearAddedItems();
        });
        
        // Make clearAddedItems available globally for debugging
        window.clearAddedItems = clearAddedItems;
        
        // Report Management Functions
        let currentReportId = null;
        
        // Function to create a new report
        async function createNewReport() {
            // Show the modal instead of using confirm
            showNewReportModal();
        }
        
        // Function to show the new report modal
        function showNewReportModal() {
            newReportModal.style.display = 'block';
            reportNameInput.value = '';
            reportNameInput.focus();
            
            // Add event listener for Enter key
            reportNameInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    confirmCreateNewReport();
                }
            });
        }
        
        // Function to close the new report modal
        function closeNewReportModal() {
            newReportModal.style.display = 'none';
        }
        
        // Function to confirm creating a new report
        async function confirmCreateNewReport() {
            const reportName = reportNameInput.value.trim();
            
            if (!reportName) {
                alert('Please enter a report name.');
                return;
            }
            
            try {
                // Create the report via API
                const response = await fetch('/backend/create_monthly_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        report_name: reportName,
                        district: districtSelect.value || '0',
                        period_type: periodSelect.value || 'month'
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Clear all checkmarks and localStorage
                    localStorage.removeItem('addedToMonthlyReport');
                    currentReportId = result.report_id;
                    
                    // Close the modal
                    closeNewReportModal();
                    
                    // Update the dropdown to include the new report
                    await populateReportDropdown();
                    
                    // Select the new report
                    currentReportSelect.value = result.report_id;
                    
                    // Refresh the table to reset all checkmarks and refetch data
                    fetchAllData();
                    
                    console.log('New report created successfully:', result);
                } else {
                    alert('Failed to create report: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating new report:', error);
                alert('Error creating new report. Please try again.');
            }
        }
        
        // Function to load an existing report
        async function loadExistingReport() {
            try {
                // Fetch available reports
                const response = await fetch('/backend/get_monthly_reports');
                const data = await response.json();
                
                if (data.status === 'success' && data.reports.length > 0) {
                    // Show a modal or dropdown to select report
                    const reportList = data.reports.map(report => 
                        `${report.id}: ${report.original_filename} (${report.item_count} items)`
                    ).join('\n');
                    
                    const selectedReport = prompt(`Select a report by ID:\n\n${reportList}\n\nEnter Report ID:`);
                    
                    if (selectedReport) {
                        const reportId = parseInt(selectedReport);
                        const report = data.reports.find(r => r.id === reportId);
                        
                        if (report) {
                            // Load the report configuration
                            await loadReportConfiguration(report);
                        } else {
                            alert('Invalid report ID selected.');
                        }
                    }
                } else {
                    alert('No existing reports found.');
                }
            } catch (error) {
                console.error('Error loading existing reports:', error);
                alert('Error loading reports. Please try again.');
            }
        }
        
        // Function to load a specific report configuration
        async function loadReportConfiguration(report) {
            try {
                console.log('Loading report configuration for report:', report);
                // Fetch the items in this report
                const response = await fetch(`/backend/get_report_items/${report.id}`);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    if (data.status === 'success' && data.items) {
                        // Clear current localStorage
                        localStorage.removeItem('addedToMonthlyReport');
                        
                        // Add items to localStorage based on report content
                        const addedItems = [];
                        data.items.forEach(item => {
                            console.log('Processing item:', item);
                            // Check if this is an anomaly by looking at the metadata
                            let itemKey;
                            if (item.metadata && item.metadata.anomaly_id) {
                                // This is an anomaly
                                itemKey = `anomaly_${item.metadata.anomaly_id}`;
                                console.log('Created anomaly key:', itemKey);
                            } else {
                                // This is a regular metric
                                itemKey = `metric_${item.metric_id}_${item.district}`;
                                console.log('Created metric key:', itemKey);
                            }
                            addedItems.push(itemKey);
                        });
                        console.log('Final addedItems:', addedItems);
                        
                        localStorage.setItem('addedToMonthlyReport', JSON.stringify(addedItems));
                        currentReportId = report.id;
                        
                        // Update UI
                        currentReportSelect.value = report.id;
                        
                        // Refresh the table to show checkmarks
                        console.log('Refreshing table with lastMetricData:', lastMetricData);
                        if (lastMetricData) {
                            // Fetch anomaly data to display alongside metrics
                            try {
                                const anomalyResponse = await fetch(`/anomaly-analyzer/api/query-anomalies?period_type=${periodSelect.value || 'month'}&limit=${limitSelect.value || 10}&only_active=true&query_type=by_anomaly_severity&district=${districtSelect.value || '0'}`);
                                const anomalyData = await anomalyResponse.json();
                                
                                if (anomalyData.status === 'success') {
                                    // Use displayCombinedResults with both metric and anomaly data
                                    displayCombinedResults(lastMetricData, anomalyData);
                                } else {
                                    // Fallback to empty anomaly data if fetch fails
                                    displayCombinedResults(lastMetricData, { positive_anomalies: [], negative_anomalies: [] });
                                }
                            } catch (error) {
                                console.error('Error fetching anomaly data:', error);
                                // Fallback to empty anomaly data
                                displayCombinedResults(lastMetricData, { positive_anomalies: [], negative_anomalies: [] });
                            }
                        } else {
                            console.log('No lastMetricData available for table refresh');
                        }
                    } else {
                        alert('Failed to load report items.');
                    }
                } else {
                    alert('Report not found or access denied.');
                }
            } catch (error) {
                console.error('Error loading report configuration:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                alert('Error loading report configuration.');
            }
        }
        
        // Function to clear all checkmarks
        async function clearAllCheckmarks() {
            if (confirm('Clear all checkmarks? This will remove all items from the current report.')) {
                localStorage.removeItem('addedToMonthlyReport');
                currentReportId = null;
                currentReportSelect.value = 'new';
                
                // Refresh the table to reset all checkmarks
                if (lastMetricData) {
                    // Fetch anomaly data to display alongside metrics
                    try {
                        const anomalyResponse = await fetch(`/anomaly-analyzer/api/query-anomalies?period_type=${periodSelect.value || 'month'}&limit=${limitSelect.value || 10}&only_active=true&query_type=by_anomaly_severity&district=${districtSelect.value || '0'}`);
                        const anomalyData = await anomalyResponse.json();
                        
                        if (anomalyData.status === 'success') {
                            displayCombinedResults(lastMetricData, anomalyData);
                        } else {
                            displayCombinedResults(lastMetricData, { positive_anomalies: [], negative_anomalies: [] });
                        }
                    } catch (error) {
                        console.error('Error fetching anomaly data:', error);
                        displayCombinedResults(lastMetricData, { positive_anomalies: [], negative_anomalies: [] });
                    }
                }
            }
        }
        
        // Function to handle report selection change
        async function handleReportChange() {
            const selectedValue = currentReportSelect.value;
            
            if (selectedValue === 'new') {
                createNewReport();
            } else {
                // Load the selected report
                const reportId = parseInt(selectedValue);
                
                // Fetch the report details
                try {
                    const response = await fetch('/backend/get_monthly_reports');
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.reports) {
                        const selectedReport = data.reports.find(report => report.id === reportId);
                        if (selectedReport) {
                            await loadReportConfiguration(selectedReport);
                        }
                    }
                } catch (error) {
                    console.error('Error loading report:', error);
                }
            }
        }
        
        // Function to populate report dropdown on page load
        async function populateReportDropdown() {
            try {
                const response = await fetch('/backend/get_monthly_reports');
                const data = await response.json();
                
                if (data.status === 'success' && data.reports.length > 0) {
                    // Clear existing options except "Create New Report"
                    currentReportSelect.innerHTML = '<option value="new">Create New Report</option>';
                    
                    // Add existing reports
                    data.reports.forEach(report => {
                        const option = document.createElement('option');
                        option.value = report.id;
                        option.textContent = `${report.original_filename} (${report.item_count} items)`;
                        currentReportSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error populating report dropdown:', error);
            }
        }
        
        // Initialize report dropdown on page load
        document.addEventListener('DOMContentLoaded', function() {
            populateReportDropdown();
            
            // Add Enter key listener for the report name input
            reportNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmCreateNewReport();
                }
            });
        });

    </script>
</body>
</html> 